import React, { useState, useEffect, useRef, useCallback } from 'react'; // Added useCallback

// Firebase configuration and imports
// Make sure to install Firebase: npm install firebase
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, Timestamp } from 'firebase/firestore'; // Corrected Firebase import

// Mock data for initial setup (These can be removed once real data is in Firebase)
const mockFestivals = [
    {
        id: 'f1',
        name: '‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏û‡∏ì‡∏µ‡∏•‡∏≠‡∏¢‡∏Å‡∏£‡∏∞‡∏ó‡∏á ‡πÄ‡∏ú‡∏≤‡πÄ‡∏ó‡∏µ‡∏¢‡∏ô ‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏ü',
        dates: '25 ‡∏û.‡∏¢. - 27 ‡∏û.‡∏¢. 2568',
        time: '18:00 - 23:00 ‡∏ô.',
        location: '‡∏≠‡∏∏‡∏ó‡∏¢‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏™‡∏∏‡πÇ‡∏Ç‡∏ó‡∏±‡∏¢, ‡∏™‡∏∏‡πÇ‡∏Ç‡∏ó‡∏±‡∏¢',
        googleMapsLink: 'https://maps.app.goo.gl/ri7pqfVo9g8V1Dru9',
        image: 'https://static.thairath.co.th/media/Dtbezn3nNUxytg04aobCfr7jZkFpfykIoDHZGR0HDcGwHS.webp',
        description: '‡∏ä‡∏°‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏™‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏™‡∏∏‡∏î‡∏ï‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡πÅ‡∏•‡∏∞‡∏Ç‡∏ö‡∏ß‡∏ô‡πÅ‡∏´‡πà‡∏Å‡∏£‡∏∞‡∏ó‡∏á‡πÉ‡∏´‡∏ç‡πà'
    },
    {
        id: 'f2',
        name: '‡∏õ‡∏£‡∏∞‡πÄ‡∏û‡∏ì‡∏µ‡∏™‡∏á‡∏Å‡∏£‡∏≤‡∏ô‡∏ï‡πå‡∏û‡∏£‡∏∞‡∏õ‡∏£‡∏∞‡πÅ‡∏î‡∏á',
        dates: '19 ‡πÄ‡∏°.‡∏¢. - 21 ‡πÄ‡∏°.‡∏¢. 2569',
        time: '‡∏ï‡∏•‡∏≠‡∏î‡∏ß‡∏±‡∏ô',
        location: '‡∏≠.‡∏û‡∏£‡∏∞‡∏õ‡∏£‡∏∞‡πÅ‡∏î‡∏á, ‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£',
        googleMapsLink: 'https://maps.app.goo.gl/PMEGhpN7sqptkJeQA',
        image: 'https://static.thairath.co.th/media/4DQpjUtzLUwmJZZSGpEFGRNWBYkBIrpxGD7tzrgz9BWV.jpg',
        description: '‡∏™‡∏±‡∏°‡∏ú‡∏±‡∏™‡∏õ‡∏£‡∏∞‡πÄ‡∏û‡∏ì‡∏µ‡∏™‡∏á‡∏Å‡∏£‡∏≤‡∏ô‡∏ï‡πå‡πÅ‡∏ö‡∏ö‡∏ä‡∏≤‡∏ß‡∏°‡∏≠‡∏ç‡∏≠‡∏±‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏≠‡∏Å‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå'
    },
    {
        id: 'f3',
        name: '‡∏á‡∏≤‡∏ô‡∏ô‡∏°‡∏±‡∏™‡∏Å‡∏≤‡∏£‡∏≠‡∏á‡∏Ñ‡πå‡∏û‡∏£‡∏∞‡∏õ‡∏ê‡∏°‡πÄ‡∏à‡∏î‡∏µ‡∏¢‡πå',
        dates: '15 ‡∏û.‡∏¢. - 23 ‡∏û.‡∏¢. 2568',
        time: '09:00 - 24:00 ‡∏ô.',
        location: '‡∏ß‡∏±‡∏î‡∏û‡∏£‡∏∞‡∏õ‡∏ê‡∏°‡πÄ‡∏à‡∏î‡∏µ‡∏¢‡πå‡∏£‡∏≤‡∏ä‡∏ß‡∏£‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏´‡∏≤‡∏£, ‡∏ô‡∏Ñ‡∏£‡∏õ‡∏ê‡∏°',
        googleMapsLink: 'https://maps.app.goo.gl/QeXcsx9UGZW2iosV9',
        image: 'https://s359.kapook.com/pagebuilder/790e41a3-cfe3-41f5-9a1a-4d2288f4f104.jpg',
        description: '‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏î‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡∏¢‡∏¥‡πà‡∏á‡πÉ‡∏´‡∏ç‡πà‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÅ‡∏´‡πà‡∏á‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏Ç‡∏≠‡∏á‡πÑ‡∏ó‡∏¢'
    },
     {
        id: 'f4',
        name: '‡∏á‡∏≤‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡∏ß‡πÑ‡∏ó‡∏¢‡∏ô‡∏≤‡∏ô‡∏≤‡∏ä‡∏≤‡∏ï‡∏¥',
        dates: '10 ‡∏°‡∏µ.‡∏Ñ. - 12 ‡∏°‡∏µ.‡∏Ñ. 2569',
        time: '10:00 - 18:00 ‡∏ô.',
        location: '‡∏´‡∏≤‡∏î‡∏ä‡∏∞‡∏≠‡∏≥, ‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏∏‡∏£‡∏µ',
        googleMapsLink: 'https://maps.app.goo.gl/uZ7QkMtBYWWcArNTA',
        image: 'https://www.mcot.net/uploads/article/202204/4d555a4bcc490efc9d91886e1fac2ad5.jpeg',
        description: '‡∏ä‡∏°‡∏ß‡πà‡∏≤‡∏ß‡∏´‡∏•‡∏≤‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏à‡∏≤‡∏Å‡∏ô‡∏≤‡∏ô‡∏≤‡∏ä‡∏≤‡∏ï‡∏¥‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏à‡∏±‡∏î‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ï‡πá‡∏°‡∏ó‡πâ‡∏≠‡∏á‡∏ü‡πâ‡∏≤'
    },
];

const mockFeatures = [
    {
        id: 'feat1',
        title: 'AI ‡∏Ñ‡∏π‡πà‡∏Ñ‡∏¥‡∏î‡∏ß‡∏≤‡∏á‡πÅ‡∏û‡∏•‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á',
        description: '‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏á‡∏ö ‡πÄ‡∏ß‡∏•‡∏≤ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ô‡πÉ‡∏à',
        icon: 'üí°', // Placeholder for icon
    },
    {
        id: 'feat2',
        title: '‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö',
        description: '‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ß‡∏•‡∏≤ ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ ‡∏Ñ‡∏£‡∏ö‡∏à‡∏ö‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏µ‡∏¢‡∏ß',
        icon: 'üó∫Ô∏è', // Placeholder for icon
    },
    {
        id: 'feat3',
        title: '‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏î‡πá‡∏î Landmark ‡∏î‡∏µ ‡∏Ç‡∏≠‡∏á‡∏ù‡∏≤‡∏Å‡∏î‡∏±‡∏á',
        description: '‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á‡∏ó‡∏±‡πà‡∏ß‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®',
        icon: '‚≠ê', // Placeholder for icon
    },
    {
        id: 'feat4',
        title: '‡∏£‡∏ß‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ OTOP ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ó‡πâ‡∏à‡∏≤‡∏Å‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ú‡∏•‡∏¥‡∏ï',
        description: '‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠',
        icon: 'üõçÔ∏è', // Placeholder for icon
    },
];

// Thai provinces data for dropdowns
const thaiProvinces = [
    "‡∏Å‡∏£‡∏∞‡∏ö‡∏µ‡πà", "‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£", "‡∏Å‡∏≤‡∏ç‡∏à‡∏ô‡∏ö‡∏∏‡∏£‡∏µ", "‡∏Å‡∏≤‡∏¨‡∏™‡∏¥‡∏ô‡∏ò‡∏∏‡πå", "‡∏Å‡∏≥‡πÅ‡∏û‡∏á‡πÄ‡∏û‡∏ä‡∏£", "‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô", "‡∏à‡∏±‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ", "‡∏â‡∏∞‡πÄ‡∏ä‡∏¥‡∏á‡πÄ‡∏ó‡∏£‡∏≤",
    "‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ", "‡∏ä‡∏±‡∏¢‡∏ô‡∏≤‡∏ó", "‡∏ä‡∏±‡∏¢‡∏†‡∏π‡∏°‡∏¥", "‡∏ä‡∏∏‡∏°‡∏û‡∏£", "‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏£‡∏≤‡∏¢", "‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà", "‡∏ï‡∏£‡∏±‡∏á", "‡∏ï‡∏£‡∏≤‡∏î", "‡∏ï‡∏≤‡∏Å", "‡∏ô‡∏Ñ‡∏£‡∏ô‡∏≤‡∏¢‡∏Å",
    "‡∏ô‡∏Ñ‡∏£‡∏õ‡∏ê‡∏°", "‡∏ô‡∏Ñ‡∏£‡∏û‡∏ô‡∏°", "‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤", "‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏ò‡∏£‡∏£‡∏°‡∏£‡∏≤‡∏ä", "‡∏ô‡∏Ñ‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå", "‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ", "‡∏ô‡∏£‡∏≤‡∏ò‡∏¥‡∏ß‡∏≤‡∏™", "‡∏ô‡πà‡∏≤‡∏ô",
    "‡∏ö‡∏∂‡∏á‡∏Å‡∏≤‡∏¨", "‡∏ö‡∏∏‡∏£‡∏µ‡∏£‡∏±‡∏°‡∏¢‡πå", "‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ", "‡∏õ‡∏£‡∏∞‡∏à‡∏ß‡∏ö‡∏Ñ‡∏µ‡∏£‡∏µ‡∏Ç‡∏±‡∏ô‡∏ò‡πå", "‡∏õ‡∏£‡∏≤‡∏à‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ", "‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ", "‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤",
    "‡∏û‡∏∞‡πÄ‡∏¢‡∏≤", "‡∏û‡∏±‡∏á‡∏á‡∏≤", "‡∏û‡∏±‡∏ó‡∏•‡∏∏‡∏á", "‡∏û‡∏¥‡∏à‡∏¥‡∏ï‡∏£", "‡∏û‡∏¥‡∏©‡∏ì‡∏∏‡πÇ‡∏•‡∏Å", "‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏∏‡∏£‡∏µ", "‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏π‡∏£‡∏ì‡πå", "‡πÅ‡∏û‡∏£‡πà", "‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï",
    "‡∏°‡∏´‡∏≤‡∏™‡∏≤‡∏£‡∏Ñ‡∏≤‡∏°", "‡∏°‡∏∏‡∏Å‡∏î‡∏≤‡∏´‡∏≤‡∏£", "‡πÅ‡∏°‡πà‡∏Æ‡πà‡∏≠‡∏á‡∏™‡∏≠‡∏ô", "‡∏¢‡πÇ‡∏™‡∏ò‡∏£", "‡∏¢‡∏∞‡∏•‡∏≤", "‡∏£‡πâ‡∏≠‡∏¢‡πÄ‡∏≠‡πá‡∏î", "‡∏£‡∏∞‡∏ô‡∏≠‡∏á", "‡∏£‡∏∞‡∏¢‡∏≠‡∏á", "‡∏£‡∏≤‡∏ä‡∏ö‡∏∏‡∏£‡∏µ",
    "‡∏•‡∏û‡∏ö‡∏∏‡∏£‡∏µ", "‡∏•‡∏≥‡∏õ‡∏≤‡∏á", "‡∏•‡∏≥‡∏û‡∏π‡∏ô", "‡πÄ‡∏•‡∏¢", "‡∏®‡∏£‡∏µ‡∏™‡∏∞‡πÄ‡∏Å‡∏©", "‡∏™‡∏Å‡∏•‡∏ô‡∏Ñ‡∏£", "‡∏™‡∏á‡∏Ç‡∏•‡∏≤", "‡∏™‡∏ï‡∏π‡∏•", "‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£",
    "‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏á‡∏Ñ‡∏£‡∏≤‡∏°", "‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£", "‡∏™‡∏£‡∏∞‡πÅ‡∏Å‡πâ‡∏ß", "‡∏™‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏µ", "‡∏™‡∏¥‡∏á‡∏´‡πå‡∏ö‡∏∏‡∏£‡∏µ", "‡∏™‡∏∏‡πÇ‡∏Ç‡∏ó‡∏±‡∏¢", "‡∏™‡∏∏‡∏û‡∏£‡∏£‡∏ì‡∏ö‡∏∏‡∏£‡∏µ", "‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ",
    "‡∏™‡∏∏‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå", "‡∏´‡∏ô‡∏≠‡∏á‡∏Ñ‡∏≤‡∏¢", "‡∏´‡∏ô‡∏≠‡∏á‡∏ö‡∏±‡∏ß‡∏•‡∏≥‡∏†‡∏π", "‡∏≠‡πà‡∏≤‡∏á‡∏ó‡∏≠‡∏á", "‡∏≠‡∏≥‡∏ô‡∏≤‡∏à‡πÄ‡∏à‡∏£‡∏¥‡∏ç", "‡∏≠‡∏∏‡∏î‡∏£‡∏ò‡∏≤‡∏ô‡∏µ", "‡∏≠‡∏∏‡∏ï‡∏£‡∏î‡∏¥‡∏ï‡∏ñ‡πå", "‡∏≠‡∏∏‡∏ó‡∏±‡∏¢‡∏ò‡∏≤‡∏ô‡∏µ",
    "‡∏≠‡∏∏‡∏ö‡∏•‡∏£‡∏≤‡∏ä‡∏ò‡∏≤‡∏ô‡∏µ"
];

const mockAttractions = [
    {
        id: 'a1',
        name: '‡∏ß‡∏±‡∏î‡∏û‡∏£‡∏∞‡∏ò‡∏≤‡∏ï‡∏∏‡∏î‡∏≠‡∏¢‡∏™‡∏∏‡πÄ‡∏ó‡∏û‡∏£‡∏≤‡∏ä‡∏ß‡∏£‡∏ß‡∏¥‡∏´‡∏≤‡∏£',
        province: '‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà',
        description: '‡∏ß‡∏±‡∏î‡∏Ñ‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô‡∏Ñ‡∏π‡πà‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà ‡∏ö‡∏ô‡∏¢‡∏≠‡∏î‡∏î‡∏≠‡∏¢‡∏™‡∏∏‡πÄ‡∏ó‡∏û ‡∏™‡∏ñ‡∏≤‡∏õ‡∏±‡∏ï‡∏¢‡∏Å‡∏£‡∏£‡∏°‡∏•‡πâ‡∏≤‡∏ô‡∏ô‡∏≤‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°',
        openingHours: '06:00 - 18:00 ‡∏ô. ‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô',
        fee: '‡∏ü‡∏£‡∏µ',
        mapLink: 'https://maps.app.goo.gl/doi-suthep',
        reviews: { avg: 4.8, count: 12500 },
        images: ['https://thesunsight.com/wp-content/uploads/2020/01/SU01-copy.jpg', 'https://www.tongnacottage.com/wp-content/uploads/2023/07/741af8955f1c4ea0956227a7ee1cec16.jpg'],
        type: '‡∏ß‡∏±‡∏í‡∏ô‡∏ò‡∏£‡∏£‡∏°',
        history: '‡∏ß‡∏±‡∏î‡∏û‡∏£‡∏∞‡∏ò‡∏≤‡∏ï‡∏∏‡∏î‡∏≠‡∏¢‡∏™‡∏∏‡πÄ‡∏ó‡∏û‡∏£‡∏≤‡∏ä‡∏ß‡∏£‡∏ß‡∏¥‡∏´‡∏≤‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏î‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Ñ‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô‡∏Ñ‡∏π‡πà‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏õ‡∏µ ‡∏û.‡∏®. 1929 ‡πÉ‡∏ô‡∏™‡∏°‡∏±‡∏¢‡∏û‡∏ç‡∏≤‡∏Å‡∏∑‡∏≠‡∏ô‡∏≤‡∏ò‡∏£‡∏£‡∏°‡∏¥‡∏Å‡∏£‡∏≤‡∏ä.',
        significance: '‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏î‡∏¥‡∏©‡∏ê‡∏≤‡∏ô‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏™‡∏≤‡∏£‡∏µ‡∏£‡∏¥‡∏Å‡∏ò‡∏≤‡∏ï‡∏∏‡∏Ç‡∏≠‡∏á‡∏û‡∏£‡∏∞‡∏û‡∏∏‡∏ó‡∏ò‡πÄ‡∏à‡πâ‡∏≤ ‡∏ã‡∏∂‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏≤‡∏£‡∏û‡∏™‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏∞‡∏Ç‡∏≠‡∏á‡∏û‡∏∏‡∏ó‡∏ò‡∏®‡∏≤‡∏™‡∏ô‡∏¥‡∏Å‡∏ä‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÇ‡∏•‡∏Å ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏∏‡∏î‡∏ä‡∏°‡∏ß‡∏¥‡∏ß‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°.'
    },
    {
        id: 'a2',
        name: '‡∏≠‡∏∏‡∏ó‡∏¢‡∏≤‡∏ô‡πÅ‡∏´‡πà‡∏á‡∏ä‡∏≤‡∏ï‡∏¥‡∏´‡∏°‡∏π‡πà‡πÄ‡∏Å‡∏≤‡∏∞‡∏≠‡πà‡∏≤‡∏á‡∏ó‡∏≠‡∏á',
        province: '‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ',
        description: '‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏Å‡∏≤‡∏∞‡∏´‡∏¥‡∏ô‡∏õ‡∏π‡∏ô‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏° ‡∏°‡∏µ‡∏ó‡∏∞‡πÄ‡∏•‡∏™‡∏≤‡∏ö‡∏°‡∏£‡∏Å‡∏ï ‡πÅ‡∏•‡∏∞‡∏à‡∏∏‡∏î‡∏ä‡∏°‡∏ß‡∏¥‡∏ß‡∏ó‡∏µ‡πà‡∏ô‡πà‡∏≤‡∏ï‡∏∑‡πà‡∏ô‡∏ï‡∏≤‡∏ï‡∏∑‡πà‡∏ô‡πÉ‡∏à',
        openingHours: '08:00 - 17:00 ‡∏ô. (‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß)',
        fee: '300 ‡∏ö‡∏≤‡∏ó (‡∏ä‡∏≤‡∏ß‡∏ï‡πà‡∏≤‡∏á‡∏ä‡∏≤‡∏ï‡∏¥), 40 ‡∏ö‡∏≤‡∏ó (‡∏Ñ‡∏ô‡πÑ‡∏ó‡∏¢)',
        mapLink: 'https://maps.app.goo.gl/jdg9jAL9WcVeWNmq9',
        reviews: { avg: 4.7, count: 8500 },
        images: ['https://ik.imagekit.io/click2go/tours/00004/gallery/01_Ang_ThongNational_Marine_Park.jpg?tr=w-720', 'https://img.kapook.com/u/2022/sutasinee/02/40_1.jpg'], // Placeholder images, replace with actual if possible
        type: '‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥',
        history: '‡∏≠‡∏∏‡∏ó‡∏¢‡∏≤‡∏ô‡πÅ‡∏´‡πà‡∏á‡∏ä‡∏≤‡∏ï‡∏¥‡∏´‡∏°‡∏π‡πà‡πÄ‡∏Å‡∏≤‡∏∞‡∏≠‡πà‡∏≤‡∏á‡∏ó‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏à‡∏±‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏∏‡∏ó‡∏¢‡∏≤‡∏ô‡πÅ‡∏´‡πà‡∏á‡∏ä‡∏≤‡∏ï‡∏¥‡∏ó‡∏≤‡∏á‡∏ó‡∏∞‡πÄ‡∏•‡πÅ‡∏´‡πà‡∏á‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢‡πÉ‡∏ô‡∏õ‡∏µ ‡∏û.‡∏®. 2523.',
        significance: '‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏´‡∏°‡∏π‡πà‡πÄ‡∏Å‡∏≤‡∏∞‡∏ô‡πâ‡∏≠‡∏¢‡πÉ‡∏´‡∏ç‡πà‡∏Å‡∏ß‡πà‡∏≤ 42 ‡πÄ‡∏Å‡∏≤‡∏∞ ‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÇ‡∏î‡∏î‡πÄ‡∏î‡πà‡∏ô‡∏ó‡∏≤‡∏á‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥ ‡∏ó‡∏±‡πâ‡∏á‡∏ó‡∏∞‡πÄ‡∏•‡∏™‡∏≤‡∏ö‡πÉ‡∏ô (‡∏ó‡∏∞‡πÄ‡∏•‡πÉ‡∏ô) ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏°‡∏£‡∏Å‡∏ï ‡πÅ‡∏•‡∏∞‡∏à‡∏∏‡∏î‡∏ä‡∏°‡∏ß‡∏¥‡∏ß‡∏ö‡∏ô‡∏¢‡∏≠‡∏î‡πÄ‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô‡∏ó‡∏¥‡∏ß‡∏ó‡∏±‡∏®‡∏ô‡πå‡∏´‡∏°‡∏π‡πà‡πÄ‡∏Å‡∏≤‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏î‡πâ.'
    },
    {
        id: 'a3',
        name: '‡∏ï‡∏•‡∏≤‡∏î‡∏ô‡πâ‡∏≥‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏™‡∏∞‡∏î‡∏ß‡∏Å',
        province: '‡∏£‡∏≤‡∏ä‡∏ö‡∏∏‡∏£‡∏µ',
        description: '‡∏ï‡∏•‡∏≤‡∏î‡∏ô‡πâ‡∏≥‡πÄ‡∏Å‡πà‡∏≤‡πÅ‡∏Å‡πà‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏ß‡∏¥‡∏ñ‡∏µ‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏ä‡∏≤‡∏ß‡∏ö‡πâ‡∏≤‡∏ô‡∏£‡∏¥‡∏°‡∏ô‡πâ‡∏≥ ‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏°‡∏≤‡∏Å‡∏°‡∏≤‡∏¢',
        openingHours: '07:00 - 15:00 ‡∏ô. ‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô',
        fee: '‡∏ü‡∏£‡∏µ (‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏∑‡∏≠‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ï‡πà‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£)',
        mapLink: 'https://maps.app.goo.gl/JDQwd4yiKANUqa2m7',
        reviews: { avg: 4.0, count: 6200 },
        images: ['https://‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡∏£‡∏≤‡∏ä‡∏ö‡∏∏‡∏£‡∏µ.com/wp-content/uploads/2013/05/IMG_8151-1200-1024x538-1024x585.jpg', 'https://www.khaosod.co.th/wpapp/uploads/2022/11/3-46.jpg'], // Placeholder images
        type: '‡∏ä‡πâ‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á & ‡∏ï‡∏•‡∏≤‡∏î',
        history: '‡∏ï‡∏•‡∏≤‡∏î‡∏ô‡πâ‡∏≥‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏™‡∏∞‡∏î‡∏ß‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏•‡∏≤‡∏î‡∏ô‡πâ‡∏≥‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πà‡∏≤‡πÅ‡∏Å‡πà‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÅ‡∏´‡πà‡∏á‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏Ç‡∏≠‡∏á‡πÑ‡∏ó‡∏¢ ‡∏°‡∏µ‡∏°‡∏≤‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏™‡∏°‡∏±‡∏¢‡∏£‡∏±‡∏ä‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà 5.',
        significance: '‡∏™‡∏∞‡∏ó‡πâ‡∏≠‡∏ô‡∏ß‡∏¥‡∏ñ‡∏µ‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏î‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏ä‡∏≤‡∏ß‡∏ö‡πâ‡∏≤‡∏ô‡∏£‡∏¥‡∏°‡∏ô‡πâ‡∏≥‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ‡πÄ‡∏£‡∏∑‡∏≠‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏°‡∏ô‡∏≤‡∏Ñ‡∏° ‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡πâ‡∏≠‡∏á‡∏ñ‡∏¥‡πà‡∏ô ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏Ñ‡∏≤‡∏ß‡∏´‡∏ß‡∏≤‡∏ô ‡πÅ‡∏•‡∏∞‡∏ú‡∏•‡πÑ‡∏°‡πâ‡∏ï‡∏≤‡∏°‡∏§‡∏î‡∏π‡∏Å‡∏≤‡∏•‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ã‡∏∑‡πâ‡∏≠‡∏°‡∏≤‡∏Å‡∏°‡∏≤‡∏¢.'
    }
];

const mockRestaurants = [
    {
        id: 'r1',
        name: '‡πÄ‡∏Æ‡∏∑‡∏≠‡∏ô‡πÄ‡∏û‡πá‡∏ç',
        province: '‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà',
        type: '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏û‡∏∑‡πâ‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á',
        priceRange: '100‚Äì300',
        images: ['https://img.wongnai.com/p/1920x0/2022/12/23/6e493a0f00b049a6b391ea48962c3e9b.jpg'],
        locationDetail: '‡∏ã‡∏≠‡∏¢‡∏£‡∏≤‡∏ä‡∏°‡∏£‡∏£‡∏Ñ‡∏≤ ‡πÉ‡∏Å‡∏•‡πâ‡∏õ‡∏£‡∏∞‡∏ï‡∏π‡∏ó‡πà‡∏≤‡πÅ‡∏û',
        googleMapsLink: 'https://maps.app.goo.gl/X2Vai5ht52DnNXX86',
        popularMenus: [
            { name: '‡∏Ç‡πâ‡∏≤‡∏ß‡∏ã‡∏≠‡∏¢‡πÑ‡∏Å‡πà', price: '50-60 ‡∏ö‡∏≤‡∏ó', image: 'https://huenphenchiangmai.com/wp-content/uploads/2024/06/4.jpg' },
            { name: '‡∏Ç‡πâ‡∏≤‡∏ß‡∏ã‡∏≠‡∏¢‡πÄ‡∏ô‡∏∑‡πâ‡∏≠', price: '50-60 ‡∏ö‡∏≤‡∏ó', image: 'https://huenphenchiangmai.com/wp-content/uploads/2024/06/5.jpg' },
            { name: '‡πÅ‡∏Å‡∏á‡∏Æ‡∏±‡∏á‡πÄ‡∏•', price: '65 ‡∏ö‡∏≤‡∏ó', image: 'https://huenphenchiangmai.com/wp-content/uploads/2024/04/IMG_3213.jpg' }
        ],
        openingHours: '‡πÄ‡∏ä‡πâ‡∏≤: 08:30-16:00, ‡πÄ‡∏¢‡πá‡∏ô: 17:00-22:00 (‡∏õ‡∏¥‡∏î‡∏ß‡∏±‡∏ô‡∏û‡∏∏‡∏ò)',
        reviews: { avg: 4.5, count: 3500 },
        userComments: [
            { user: '‡∏ô‡∏±‡∏Å‡∏ä‡∏¥‡∏°‡∏ï‡∏±‡∏ß‡∏à‡∏£‡∏¥‡∏á', comment: '‡∏Ç‡πâ‡∏≤‡∏ß‡∏ã‡∏≠‡∏¢‡∏≠‡∏£‡πà‡∏≠‡∏¢‡∏°‡∏≤‡∏Å ‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏Å‡∏≤‡∏®‡∏£‡πâ‡∏≤‡∏ô‡∏î‡∏µ‡∏á‡∏≤‡∏°', image: 'https://placehold.co/100x100/E0E0E0/000?text=User1' }
        ]
    },
    {
        id: 'r2',
        name: '‡∏Ç‡∏≤‡∏´‡∏°‡∏π‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡πÅ‡∏™‡∏á‡∏™‡∏µ‡∏•‡∏°',
        province: '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£',
        type: '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏à‡∏≤‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß',
        priceRange: '101 - 250 ‡∏ö‡∏≤‡∏ó',
        images: ['https://image.bangkokbiznews.com/uploads/images/md/2022/04/9xijtE2tECIUbff8Stqo.webp', 'https://1.bp.blogspot.com/-axBjnFOxbM4/YJvs-zdVR1I/AAAAAAABXwk/EbHbJv-i1kAKV-bhFSzl14ckB0DCLFU-ACLcBGAsYHQ/s1200/q1xhyi6wuhle.jpg'],
        locationDetail: '‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡∏Å‡∏£‡∏∏‡∏á 49 ‡πÅ‡∏Ç‡∏ß‡∏á‡∏™‡∏∏‡∏£‡∏¥‡∏¢‡∏ß‡∏á‡∏®‡πå',
        googleMapsLink: 'https://maps.app.goo.gl/FragrFrbufVSXfsb6',
        popularMenus: [
            { name: '‡∏Ç‡πâ‡∏≤‡∏ß‡∏Ç‡∏≤‡∏´‡∏°‡∏π‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏ô‡∏±‡∏á', price: '40 ‡∏ö‡∏≤‡∏ó', image: 'https://img.wongnai.com/p/1920x0/2017/03/28/45bf5bafeca84a00b9f260201e5df68c.jpg' },
            { name: '‡∏Ç‡πâ‡∏≤‡∏ß‡∏Ç‡∏≤‡∏´‡∏°‡∏π‡∏Ñ‡∏≤‡∏Å‡∏¥', price: '75 ‡∏ö‡∏≤‡∏ó', image: 'https://img.wongnai.com/p/1920x0/2020/12/03/01941eabda60409b874c5d44f066b9be.jpg' }
        ],
        openingHours: '‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô: 07:30 - 13:30',
        reviews: { avg: 4.4, count: 4147 },
        userComments: [
            { user: 'kongkait', comment: '‡∏Ç‡∏≤‡∏´‡∏°‡∏π ‡∏≠‡∏£‡πà‡∏≠‡∏¢‡∏•‡∏∞‡∏°‡∏∏‡∏ô‡∏•‡∏¥‡πâ‡∏ô', image: 'https://placehold.co/100x100/E0E0E0/000?text=User2' }
        ]
    }
];

const mockOtopProducts = [
    {
        id: 'o1',
        name: '‡∏ú‡πâ‡∏≤‡πÑ‡∏´‡∏°‡∏¢‡∏Å‡∏î‡∏≠‡∏Å‡∏•‡∏≥‡∏û‡∏π‡∏ô',
        category: '‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ú‡πâ‡∏≤',
        description: '‡∏ú‡πâ‡∏≤‡πÑ‡∏´‡∏°‡∏ó‡∏≠‡∏°‡∏∑‡∏≠‡∏•‡∏≤‡∏¢‡∏¢‡∏Å‡∏î‡∏≠‡∏Å‡πÇ‡∏ö‡∏£‡∏≤‡∏ì ‡∏™‡∏∑‡∏ö‡∏ó‡∏≠‡∏î‡∏°‡∏≤‡πÅ‡∏ï‡πà‡∏ö‡∏£‡∏£‡∏û‡∏ö‡∏∏‡∏£‡∏∏‡∏© ‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡∏ì‡∏µ‡∏ï‡∏á‡∏î‡∏á‡∏≤‡∏°',
        origin: '‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏•‡∏≥‡∏û‡∏π‡∏ô',
        price: '1500‚Äì5000 ‡∏ö‡∏≤‡∏ó (‡∏ï‡πà‡∏≠‡∏ú‡∏∑‡∏ô)',
        producer: '‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ß‡∏¥‡∏™‡∏≤‡∏´‡∏Å‡∏¥‡∏à‡∏ä‡∏∏‡∏°‡∏ä‡∏ô‡∏ú‡πâ‡∏≤‡πÑ‡∏´‡∏°‡∏¢‡∏Å‡∏î‡∏≠‡∏Å',
        purchaseChannels: {
            line: 'https://lin.ee/o47Txru', facebook: 'https://www.facebook.com/ThaiSilkLamphun/?locale=th_TH', phone: '0812345678', shopee: '#', lazada: '#', website: 'https://lamphunthaisilk.com/',
            physicalStore: 'https://maps.app.goo.gl/lamphun-silk'
        },
        images: ['https://scontent.fcnx3-1.fna.fbcdn.net/v/t39.30808-6/484322737_957328663240823_6212818639101693774_n.jpg?_nc_cat=110&ccb=1-7&_nc_sid=cc71e4&_nc_eui2=AeFlx5EuLw3sxHc_VJ_SrL_ffdZ5e8fms9V91nl7x-az1QoqgRn6a-F1BCz7MoK6CiFEKET6Xvks05Axtrc6SDBM&_nc_ohc=JXRkAxmNfngQ7kNvwFZPpVx&_nc_oc=AdmR72BYpgPz69n2lPI6p_p521sINBFw57ICArRwqmI1f_K_6yQFXk0agi-0DnrgBce-YFPTfkTguwFvMozIRhd&_nc_zt=23&_nc_ht=scontent.fcnx3-1.fna&_nc_gid=WG5E9j-uQuI-CAsI9zuuag&oh=00_AfPDD9OiNc0umbo-vK8yI8YbQcDJd2gg7dr8hVesljuowg&oe=686453B6'],
        rating: 5,
        canOrderOnline: true
    },
    {
        id: 'o2',
        name: '‡∏ô‡πâ‡∏≥‡∏ú‡∏∂‡πâ‡∏á‡∏î‡∏≠‡∏Å‡∏™‡∏≤‡∏ö‡πÄ‡∏™‡∏∑‡∏≠',
        category: '‡∏≠‡∏≤‡∏´‡∏≤‡∏£',
        description: '‡∏ô‡πâ‡∏≥‡∏ú‡∏∂‡πâ‡∏á‡∏à‡∏≤‡∏Å‡∏î‡∏≠‡∏Å‡∏™‡∏≤‡∏ö‡πÄ‡∏™‡∏∑‡∏≠ ‡∏Ñ‡∏∑‡∏≠ ‡∏ô‡πâ‡∏≥‡∏ú‡∏∂‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏ô‡πâ‡∏≥‡∏´‡∏ß‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏î‡∏≠‡∏Å‡∏™‡∏≤‡∏ö‡πÄ‡∏™‡∏∑‡∏≠ ‡∏ã‡∏∂‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏∑‡∏ä‡∏™‡∏°‡∏∏‡∏ô‡πÑ‡∏û‡∏£‡∏Ç‡∏≠‡∏á‡∏†‡∏≤‡∏Ñ‡πÄ‡∏´‡∏ô‡∏∑‡∏≠ ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥‡∏ú‡∏∂‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏°‡∏µ‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡∏ó‡∏≠‡∏á ‡πÅ‡∏•‡∏∞ ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏Å‡∏•‡∏¥‡πà‡∏ô‡∏´‡∏≠‡∏°‡∏≠‡πà‡∏≠‡∏ô‡πÜ ‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û ‡πÇ‡∏î‡∏¢ ‡∏®‡∏π‡∏ô‡∏¢‡πå ‡πÇ‡∏≠‡∏ó‡∏≠‡∏õ ‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà',
        origin: '‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà',
        price: '130 ‡∏ö‡∏≤‡∏ó',
        producer: '‡∏®‡∏π‡∏ô‡∏¢‡πå ‡πÇ‡∏≠‡∏ó‡∏≠‡∏õ ‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà',
        purchaseChannels: {
            line: '#', facebook: '#', phone: '#', shopee: '#', lazada: '#', website: 'https://www.otopchiangmai.com/page/id/%E0%B8%99%E0%B9%89%E0%B8%B3%E0%B8%9C%E0%B8%B6%E0%B9%89%E0%B8%87-%E0%B8%94%E0%B8%AD%E0%B8%81%E0%B8%AA%E0%B8%B2%E0%B8%9A%E0%B9%80%E0%B8%AA%E0%B8%B7%E0%B8%AD-%E0%B8%A8%E0%B8%B9%E0%B8%99%E0%B8%A2%E0%B9%8C-otop-%E0%B9%80%E0%B8%8A%E0%B8%B5%E0%B8%A2%E0%B8%87%E0%B9%83%E0%B8%AB%E0%B8%A1%E0%B9%88',
            physicalStore: 'https://maps.app.goo.gl/chiangmai-chili'
        },
        images: ['https://www.otopchiangmai.com/resize.php?src=uploads/2f7116dd55348c1618d5496eb35b0be4.jpg&w=400&h=400&os=1'],
        rating: 4,
        canOrderOnline: true
    }
];


// Main App Component
const App = () => {
    // Retrieve __app_id from the global scope. If not defined, use a default ID.
    // This allows the app to run outside of the Canvas environment, but Firebase functionality
    // will require proper configuration via environment variables or a .env file.
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-travel-app';

    // State to manage current page view
    const [currentPage, setCurrentPage] = useState('home');
    // Firebase state variables
    const [db, setDb] = useState(null);
    const [auth, setAuth] = useState(null);
    const [user, setUser] = useState(null);
    const [isAuthReady, setIsAuthReady] = useState(false);
    const [userId, setUserId] = useState('anonymous'); // Default to anonymous

    // Set currentPage to 'home' explicitly when the component is rendered, regardless of login state
    useEffect(() => {
        setCurrentPage('home');
    }, []);

    // Initialize Firebase
    useEffect(() => {
        try {
            // Retrieve __firebase_config from the global scope.
            // In a real deployed app, you would use environment variables like:
            // const firebaseConfig = {
            //   apiKey: process.env.REACT_APP_FIREBASE_API_KEY,
            //   authDomain: process.env.REACT_APP_FIREBASE_AUTH_DOMAIN,
            //   projectId: process.env.REACT_APP_FIREBASE_PROJECT_ID,
            //   storageBucket: process.env.REACT_APP_FIREBASE_STORAGE_BUCKET,
            //   messagingSenderId: process.env.REACT_APP_FIREBASE_MESSAGING_SENDER_ID,
            //   appId: process.env.REACT_APP_FIREBASE_APP_ID
            // };
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;

            if (!firebaseConfig || !firebaseConfig.apiKey) {
                console.warn("Firebase config is not fully available. Firebase features may not work. Ensure __firebase_config is set or use environment variables.");
                // We will still initialize app but expect errors if functions are called without proper config
            }

            const app = initializeApp(firebaseConfig || {}); // Initialize with empty object if config is null
            const firestore = getFirestore(app);
            const authentication = getAuth(app);

            setDb(firestore);
            setAuth(authentication);

            // Listen for auth state changes
            const unsubscribe = onAuthStateChanged(authentication, async (currentUser) => {
                if (currentUser) {
                    setUser(currentUser);
                    setUserId(currentUser.uid);
                    console.log("Authenticated with UID:", currentUser.uid);
                    setIsAuthReady(true);
                } else {
                    let signedIn = false;
                    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                    if (initialAuthToken) {
                        try {
                            console.log("Attempting to sign in with custom token...");
                            await signInWithCustomToken(authentication, initialAuthToken);
                            console.log("Signed in with custom token.");
                            signedIn = true; // Mark as signed in if custom token works
                        } catch (tokenError) {
                            console.error("Error signing in with custom token:", tokenError);
                            // If custom token fails, proceed to try anonymous sign-in below
                        }
                    }

                    if (!signedIn) { // Only attempt anonymous if custom token not tried or failed
                        try {
                            console.log("Attempting to sign in anonymously...");
                            await signInAnonymously(authentication);
                            console.log("Signed in anonymously.");
                        } catch (anonError) {
                            console.error("Failed to sign in anonymously:", anonError);
                            // If anonymous sign-in also fails, ensure user state is cleared
                            setUser(null);
                            setUserId('anonymous');
                        }
                    }
                    setIsAuthReady(true); // Mark auth as ready after all sign-in attempts
                }
            });

            // Clean up subscription on unmount
            return () => unsubscribe();
        } catch (error) {
            console.error("Failed to initialize Firebase:", error);
        }
    }, []); // Empty dependency array ensures this runs only once on mount.

    // Function to handle mock login (for demo purposes)
    const handleLoginSuccess = (mockUser) => {
        setUser(mockUser);
        setUserId(mockUser.uid || crypto.randomUUID()); // Use Firebase UID if available, else a random UUID for mock
        setCurrentPage('dashboard'); // Navigate to dashboard after successful login
    };

    // Global UI for Navigation (once logged in)
    const Navbar = () => {
        if (!user) return null; // Only show navbar if user is logged in
        // NOTE: Changed to fixed bottom navigation
        return (
            <nav className="bg-gradient-to-r from-blue-600 to-blue-800 p-2 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] fixed bottom-0 w-full z-50">
                <div className="container mx-auto flex justify-around items-center">
                    {/* Simplified for bottom nav */}
                     <button
                        className="flex flex-col items-center text-white hover:text-blue-200 px-2 py-1 rounded-lg transition duration-300 font-['Prompt']"
                        onClick={() => setCurrentPage('dashboard')}
                    >
                        <span className="text-2xl">üè†</span>
                        <span className="text-xs">‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</span>
                    </button>
                    <button
                        className="flex flex-col items-center text-white hover:text-blue-200 px-2 py-1 rounded-lg transition duration-300 font-['Prompt']"
                        onClick={() => setCurrentPage('attractions')}
                    >
                        <span className="text-2xl">üèûÔ∏è</span>
                        <span className="text-xs">‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏ó‡∏¢</span>
                    </button>
                    <button
                        className="flex flex-col items-center text-white hover:text-blue-200 px-2 py-1 rounded-lg transition duration-300 font-['Prompt']"
                        onClick={() => setCurrentPage('restaurants')}
                    >
                        <span className="text-2xl">üçú</span>
                        <span className="text-xs">‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏î‡πá‡∏î‡∏î‡∏±‡∏á</span>
                    </button>
                    <button
                        className="flex flex-col items-center text-white hover:text-blue-200 px-2 py-1 rounded-lg transition duration-300 font-['Prompt']"
                        onClick={() => setCurrentPage('otop')}
                    >
                        <span className="text-2xl">üõçÔ∏è</span>
                        <span className="text-xs">OTOP</span>
                    </button>
                    <button
                        className="flex flex-col items-center text-white hover:text-blue-200 px-2 py-1 rounded-lg transition duration-300 font-['Prompt']"
                        onClick={() => setCurrentPage('reviews')}
                    >
                        <span className="text-2xl">‚≠ê</span>
                        <span className="text-xs">‡∏£‡∏µ‡∏ß‡∏¥‡∏ß</span>
                    </button>
                </div>
            </nav>
        );
    };

    // --- Components for each page ---

    // Home Page (Pre-Login)
    const HomePage = () => {
        const [festivalIndex, setFestivalIndex] = useState(0);
        const [featureIndex, setFeatureIndex] = useState(0);

        useEffect(() => {
            // Auto-advance festivals
            const festivalInterval = setInterval(() => {
                setFestivalIndex((prevIndex) => (prevIndex + 1) % mockFestivals.length);
            }, 5000); // Change festival every 5 seconds

            // Auto-advance features
            const featureInterval = setInterval(() => {
                setFeatureIndex((prevIndex) => (prevIndex + 1) % mockFeatures.length);
            }, 4000); // Change feature every 4 seconds

            return () => {
                clearInterval(festivalInterval);
                clearInterval(featureInterval);
            };
        }, []);

        return (
            <div className="min-h-screen bg-gray-100 flex flex-col items-center py-10 font-['Prompt']">
                {/* Header */}
                <header className="w-full bg-blue-700 text-white p-6 text-center shadow-lg">
                    <h1 className="text-4xl font-bold mb-2">Travel Thailand</h1>
                    <p className="text-xl">‡∏Ñ‡πâ‡∏ô‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÉ‡∏Ñ‡∏£</p>
                </header>

                {/* Festivals Section */}
                <section className="w-full max-w-4xl bg-white p-6 rounded-xl shadow-lg mt-8 text-center">
                    <h2 className="text-3xl font-semibold text-blue-800 mb-6">‡∏á‡∏≤‡∏ô‡πÄ‡∏ó‡∏®‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà‡∏ô‡πà‡∏≤‡∏™‡∏ô‡πÉ‡∏à‡∏ó‡∏±‡πà‡∏ß‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®</h2>
                    <div className="relative overflow-hidden h-96 rounded-xl mb-6">
                        <div
                            className="flex transition-transform duration-700 ease-in-out"
                            style={{ transform: `translateX(-${festivalIndex * 100}%)` }}
                        >
                            {mockFestivals.map((festival) => (
                                <div key={festival.id} className="w-full flex-shrink-0">
                                    <div className="relative h-96 flex items-center justify-center">
                                        <img
                                            src={festival.image}
                                            alt={festival.name}
                                            className="absolute inset-0 w-full h-full object-cover rounded-xl"
                                            onError={(e) => { e.target.onerror = null; e.target.src="https://placehold.co/400x250/E0E0E0/000?text=No+Image"; }}
                                        />
                                        <div className="absolute inset-0 bg-black bg-opacity-50 flex flex-col justify-end p-6 text-white rounded-xl">
                                            <h3 className="text-3xl font-bold mb-2">{festival.name}</h3>
                                            <p className="text-lg">üóìÔ∏è {festival.dates}</p>
                                            <p className="text-lg">‚è∞ {festival.time}</p>
                                            <p className="text-lg">üìç {festival.location} <a href={festival.googleMapsLink} target="_blank" rel="noopener noreferrer" className="text-blue-300 hover:underline">(‡∏î‡∏π‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà)</a></p>
                                            <button className="mt-4 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-full transition duration-300 self-center">
                                                ‡∏î‡∏π‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                    <div className="flex justify-center space-x-2">
                        {mockFestivals.map((_, idx) => (
                            <button
                                key={idx}
                                className={`h-3 w-3 rounded-full ${festivalIndex === idx ? 'bg-blue-600' : 'bg-gray-300'} transition-colors duration-300`}
                                onClick={() => setFestivalIndex(idx)}
                            ></button>
                        ))}
                    </div>
                </section>

                {/* Features Section */}
                <section className="w-full max-w-4xl bg-white p-6 rounded-xl shadow-lg mt-8 text-center">
                    <h2 className="text-3xl font-semibold text-blue-800 mb-6">‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô (‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡πÄ‡∏î‡πà‡∏ô)</h2>
                    <div className="relative overflow-hidden h-60 rounded-xl mb-6">
                        <div
                            className="flex transition-transform duration-700 ease-in-out"
                            style={{ transform: `translateX(-${featureIndex * 100}%)` }}
                        >
                            {mockFeatures.map((feature) => (
                                <div key={feature.id} className="w-full flex-shrink-0 flex flex-col items-center justify-center p-4">
                                    <div className="text-6xl mb-4 text-blue-600">{feature.icon}</div>
                                    <h3 className="text-2xl font-bold text-gray-800 mb-2">{feature.title}</h3>
                                    <p className="text-lg text-gray-600">{feature.description}</p>
                                </div>
                            ))}
                        </div>
                    </div>
                    <div className="flex justify-center space-x-2">
                        {mockFeatures.map((_, idx) => (
                            <button
                                key={idx}
                                className={`h-3 w-3 rounded-full ${featureIndex === idx ? 'bg-blue-600' : 'bg-gray-300'} transition-colors duration-300`}
                                onClick={() => setFeatureIndex(idx)}
                            ></button>
                        ))}
                    </div>
                </section>

                {/* Login Button */}
                <div className="mt-10">
                    <button
                        onClick={() => setCurrentPage('login')}
                        className="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transform transition duration-300 hover:scale-105 text-xl font-['Prompt']"
                    >
                        ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
                    </button>
                </div>
            </div>
        );
    };

    // Login Page
    const LoginPage = () => {
        const [username, setUsername] = useState('');
        const [password, setPassword] = useState('');
        const [showPassword, setShowPassword] = useState(false);
        const [loading, setLoading] = useState(false);
        const [error, setError] = useState('');

        const handleLogin = async (e) => {
            e.preventDefault();
            setError('');
            setLoading(true);

            if (!username || !password) {
                setError('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ/‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô');
                setLoading(false);
                return;
            }

            // Simulate API call for login
            try {
                // In a real app, you would use Firebase Auth's signInWithEmailAndPassword here
                // For demonstration, we'll simulate success after a delay
                await new Promise(resolve => setTimeout(resolve, 1500)); // Simulate network delay

                if (username === 'test@example.com' && password === 'password123') {
                    handleLoginSuccess({ uid: 'mock_user_123', email: username, displayName: '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö' });
                } else {
                    setError('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                }
            } catch (err) {
                setError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö');
                console.error("Login error:", err);
            } finally {
                setLoading(false);
            }
        };

        const SocialLoginButton = ({ icon, text, bgColor, hoverBgColor }) => (
            <button
                className={`flex items-center justify-center w-full py-3 px-4 rounded-xl shadow-md transition duration-300 hover:scale-[1.02] ${bgColor} ${hoverBgColor} text-white font-bold mb-3 font-['Prompt']`}
                onClick={() => {
                    setError('');
                    // Replaced alert with console.log as alerts are not good for UI/UX
                    console.log(`‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢ ${text} (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Ç‡∏∂‡πâ‡∏ô)`);
                    // In a real app, trigger Firebase Social Auth (e.g., signInWithPopup for Google/Facebook)
                    // For mock, just navigate to dashboard
                    handleLoginSuccess({ uid: `mock_${text.toLowerCase()}_user`, displayName: `${text} User` });
                }}
            >
                <span className="text-2xl mr-3">{icon}</span> {text}
            </button>
        );

        return (
            <div className="min-h-screen bg-gradient-to-br from-blue-100 to-indigo-200 flex items-center justify-center p-4 font-['Prompt']">
                <div className="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md transform transition-all duration-300 hover:scale-[1.01] border border-gray-200">
                    <h2 className="text-4xl font-bold text-center text-gray-800 mb-8">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>

                    {/* Username/Email & Password Form */}
                    <form onSubmit={handleLogin} className="space-y-6">
                        {/* Username/Email Input */}
                        <div>
                            <label htmlFor="username" className="block text-gray-700 text-lg font-medium mb-2">
                                ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏µ‡πÄ‡∏°‡∏•
                            </label>
                            <div className="relative">
                                <span className="absolute inset-y-0 left-0 flex items-center pl-3">
                                    {/* User icon */}
                                    <svg className="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                    </svg>
                                </span>
                                <input
                                    type="text"
                                    id="username"
                                    className="pl-12 pr-4 py-3 w-full border border-gray-300 rounded-xl focus:ring-blue-500 focus:border-blue-500 text-lg placeholder-gray-400 focus:outline-none"
                                    placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏µ‡πÄ‡∏°‡∏•"
                                    value={username}
                                    onChange={(e) => { setUsername(e.target.value); setError(''); }}
                                    required
                                />
                            </div>
                        </div>

                        {/* Password Input */}
                        <div>
                            <label htmlFor="password" className="block text-gray-700 text-lg font-medium mb-2">
                                ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
                            </label>
                            <div className="relative">
                                <input
                                    type={showPassword ? 'text' : 'password'}
                                    id="password"
                                    className="pr-12 pl-4 py-3 w-full border border-gray-300 rounded-xl focus:ring-blue-500 focus:border-blue-500 text-lg placeholder-gray-400 focus:outline-none"
                                    placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô"
                                    value={password}
                                    onChange={(e) => { setPassword(e.target.value); setError(''); }}
                                    required
                                />
                                <button
                                    type="button"
                                    className="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-500 hover:text-gray-700 focus:outline-none"
                                    onClick={() => setShowPassword(!showPassword)}
                                    aria-label={showPassword ? '‡∏ã‡πà‡∏≠‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô' : '‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô'}
                                >
                                    {showPassword ? (
                                        // Eye slash icon
                                        <svg className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13.875 18.25L10.125 10.125M6.25 6.25L18.25 18.25" />
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M1.25 12s2.75 7 10.75 7 10.75-7 10.75-7-2.75-7-10.75-7-10.75 7-10.75 7z" />
                                        </svg>
                                    ) : (
                                        // Eye icon
                                        <svg className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                        </svg>
                                    )}
                                </button>
                            </div>
                            <p className="text-sm text-gray-500 mt-2">* ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏≠‡∏∑‡πà‡∏ô</p>
                        </div>

                        {/* Error Message */}
                        {error && <p className="text-red-500 text-center text-sm">{error}</p>}

                        {/* Login Button */}
                        <button
                            type="submit"
                            className={`w-full py-3 rounded-xl shadow-lg transition duration-300 text-white font-bold text-xl ${
                                !username || !password || loading
                                    ? 'bg-blue-400 cursor-not-allowed'
                                    : 'bg-blue-600 hover:bg-blue-700'
                            }`}
                            disabled={!username || !password || loading}
                        >
                            {loading ? (
                                <span className="flex items-center justify-center">
                                    <svg className="animate-spin h-5 w-5 mr-3 text-white" viewBox="0 0 24 24">
                                        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                    ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...
                                </span>
                            ) : (
                                '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö'
                            )}
                        </button>
                    </form>

                    {/* Divider */}
                    <div className="flex items-center my-6">
                        <hr className="flex-grow border-t border-gray-300" />
                        <span className="px-4 text-gray-500 text-lg">‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢</span>
                        <hr className="flex-grow border-t border-gray-300" />
                    </div>

                    {/* Social Media Login Buttons */}
                    <div className="space-y-3">
                        <SocialLoginButton
                            icon={<svg className="h-6 w-6" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path fillRule="evenodd" d="M22 12c0-5.523-4.477-10-10-10S2 6.477 2 12c0 4.991 3.657 9.128 8.438 9.877v-7.52h-2.54V12h2.54V9.797c0-2.505 1.492-3.89 3.776-3.89 1.094 0 2.238.195 2.238.195v2.46h-1.26c-1.243 0-1.63.771-1.63 1.562V12h2.773l-.443 2.89h-2.33V22H12c5.523 0 10-4.477 10-10z" clipRule="evenodd" /></svg>}
                            text="Facebook"
                            bgColor="bg-blue-800"
                            hoverBgColor="hover:bg-blue-900"
                        />
                        <SocialLoginButton
                            icon={<svg className="h-6 w-6" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm-2.03 17.502h-3.411v-10.005h3.411v10.005zm-1.706-11.458c-.94 0-1.706-.764-1.706-1.706s.764-1.706 1.706-1.706 1.706.764 1.706 1.706-.764 1.706-1.706 1.706zm3.649 11.458h3.411v-5.596c0-1.336.711-1.895 1.748-1.895 1.037 0 1.503.791 1.503 1.895v5.596h3.411v-6.09c0-3.328-1.776-4.954-4.14-4.954-1.98 0-2.883 1.157-3.364 1.905h-.028v-1.657h-3.411s.046.216.046 10.005z"/></svg>}
                            text="Gmail (Google)"
                            bgColor="bg-red-600"
                            hoverBgColor="hover:bg-red-700"
                        />
                        <SocialLoginButton
                            icon={<svg className="h-6 w-6" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path fillRule="evenodd" d="M12 0c-3.376 0-3.797.016-5.137.076-1.34.06-2.203.27-2.98.585-.748.308-1.456.723-2.112 1.379-.656.656-1.071 1.364-1.379 2.112-.315.777-.525 1.64-.585 2.98-.06 1.34-.076 1.761-.076 5.137s.016 3.797.076 5.137c.06 1.34.27 2.203.585 2.98.308.748.723 1.456 1.379 2.112.656.656 1.364 1.071 1.379 2.112-.777.315-1.64.525-2.98.585-1.34.06-1.761.076-5.137.076s3.797-.016 5.137-.076c1.34-.06 2.203-.27 2.98-.585.748-.308 1.456-.723 2.112-1.379.656-.656 1.071-1.364 1.379-2.112.315-.777-.525 1.64-.585 2.98.06-1.34.076-1.761.076-5.137s-.013-3.659-.071-4.949c-.057-1.29-.254-1.954-.441-2.428-.17-.442-.384-.8-.741-1.157-.357-.357-.715-.571-.741-1.157-.187-.474-.384-1.138-.441-2.428-.058-1.29-.071-1.682-.071-4.949z"/></svg>}
                            text="Instagram"
                            bgColor="bg-gradient-to-tr from-yellow-400 via-red-500 to-pink-600"
                            hoverBgColor="hover:from-yellow-500 hover:via-red-600 hover:to-pink-700"
                        />
                    </div>

                    <p className="text-center text-gray-600 mt-6 text-lg">
                        ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ?{' '}
                        <button
                            onClick={() => console.log('‡∏ô‡∏≥‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á)')} // Mock navigation
                            className="text-blue-600 hover:underline font-bold focus:outline-none"
                        >
                            ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
                        </button>
                    </p>
                    <p className="text-center text-gray-500 mt-2 text-sm">
                        User ID: {userId}
                    </p>
                </div>
            </div>
        );
    };

    // Dashboard Page (After Login) - MODIFIED with new AI options
    const DashboardPage = () => {
        const [origin, setOrigin] = useState(''); // Changed initial state
        const [destination, setDestination] = useState('');
        const [aiSuggestion, setAiSuggestion] = useState(null);
        const [aiLoading, setAiLoading] = useState(false);
        const [aiError, setAiError] = useState('');

        // NEW: State for multiple trip styles
        const [tripStyles, setTripStyles] = useState({
            fastest: false,
            economical: false,
            foodie: false,
            cultural: false,
            nature: false,
            spiritual: false,
            adventure: false,
            photography: false,
            shopping: false,
        });

        // Trip style options for UI
        const tripStyleOptions = [
            { id: 'fastest', label: '‡πÄ‡∏£‡πá‡∏ß‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î', icon: 'üöÄ' },
            { id: 'economical', label: '‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î', icon: 'üí∞' },
            { id: 'foodie', label: '‡∏™‡∏≤‡∏¢‡∏Å‡∏¥‡∏ô', icon: 'üçú' },
            { id: 'cultural', label: '‡∏™‡∏≤‡∏¢‡∏ß‡∏±‡∏í‡∏ô‡∏ò‡∏£‡∏£‡∏°', icon: 'üèõÔ∏è' },
            { id: 'nature', label: '‡∏™‡∏≤‡∏¢‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥', icon: 'üå≥' },
            { id: 'spiritual', label: '‡∏™‡∏≤‡∏¢‡∏°‡∏π', icon: 'üôè' },
            { id: 'adventure', label: '‡∏™‡∏≤‡∏¢‡∏ú‡∏à‡∏ç‡∏†‡∏±‡∏¢', icon: 'üßó' },
            { id: 'photography', label: '‡πÄ‡∏ô‡πâ‡∏ô‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ', icon: 'üì∏' },
            { id: 'shopping', label: '‡πÄ‡∏ô‡πâ‡∏ô‡∏ä‡πâ‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á', icon: 'üõçÔ∏è' },
        ];

        // New states for interactive trip builder
        const [suggestedPlaces, setSuggestedPlaces] = useState([]);
        const [selectedPlaces, setSelectedPlaces] = useState([]);
        const [showTripBuilder, setShowTripBuilder] = useState(false);

        // Handler for checkbox changes
        const handleStyleChange = (styleId) => {
            setTripStyles(prevStyles => ({
                ...prevStyles,
                [styleId]: !prevStyles[styleId]
            }));
        };

        const handleAiPlanTrip = async () => {
            const selectedStyles = Object.entries(tripStyles)
                .filter(([key, value]) => value)
                .map(([key]) => {
                    const labels = {
                        fastest: "‡πÄ‡∏£‡πá‡∏ß‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î",
                        economical: "‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î",
                        foodie: "‡∏™‡∏≤‡∏¢‡∏Å‡∏¥‡∏ô (‡πÄ‡∏ô‡πâ‡∏ô‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏≠‡∏£‡πà‡∏≠‡∏¢‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≤‡πÄ‡∏ü‡πà)",
                        cultural: "‡∏™‡∏≤‡∏¢‡∏ß‡∏±‡∏í‡∏ô‡∏ò‡∏£‡∏£‡∏° (‡πÄ‡∏ô‡πâ‡∏ô‡∏ß‡∏±‡∏î, ‡πÇ‡∏ö‡∏£‡∏≤‡∏ì‡∏™‡∏ñ‡∏≤‡∏ô, ‡∏û‡∏¥‡∏û‡∏¥‡∏ò‡∏†‡∏±‡∏ì‡∏ë‡πå)",
                        nature: "‡∏™‡∏≤‡∏¢‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥ (‡πÄ‡∏ô‡πâ‡∏ô‡∏≠‡∏∏‡∏ó‡∏¢‡∏≤‡∏ô, ‡∏†‡∏π‡πÄ‡∏Ç‡∏≤, ‡∏ô‡πâ‡∏≥‡∏ï‡∏Å)",
                        spiritual: "‡∏™‡∏≤‡∏¢‡∏°‡∏π (‡πÄ‡∏ô‡πâ‡∏ô‡∏ß‡∏±‡∏î‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå, ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏û‡∏£)",
                        adventure: "‡∏™‡∏≤‡∏¢‡∏ú‡∏à‡∏ç‡∏†‡∏±‡∏¢ (‡πÄ‡∏ô‡πâ‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡πâ‡∏≤‡∏ó‡∏≤‡∏¢, ‡πÄ‡∏î‡∏¥‡∏ô‡∏õ‡πà‡∏≤)",
                        photography: "‡πÄ‡∏ô‡πâ‡∏ô‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ (‡πÄ‡∏ô‡πâ‡∏ô‡∏à‡∏∏‡∏î‡∏ä‡∏°‡∏ß‡∏¥‡∏ß‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°, ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πã‡πÜ)",
                        shopping: "‡πÄ‡∏ô‡πâ‡∏ô‡∏ä‡πâ‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á (‡πÄ‡∏ô‡πâ‡∏ô‡∏ï‡∏•‡∏≤‡∏î, ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏ù‡∏≤‡∏Å, ‡∏´‡πâ‡∏≤‡∏á‡∏™‡∏£‡∏£‡∏û‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤)",
                    };
                    return labels[key];
                });

            if (!origin || !destination) {
                setAiError('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏à‡∏∏‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á');
                return;
            }
            if (selectedStyles.length === 0) {
                setAiError('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏≠‡∏¢‡πà‡∏≤‡∏á');
                return;
            }

            setAiLoading(true);
            setAiSuggestion(null);
            setAiError('');
            setShowTripBuilder(false);

            const stylesText = selectedStyles.join(', ');
            const prompt = `‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏à‡∏≤‡∏Å ${origin} ‡πÑ‡∏õ‡∏¢‡∏±‡∏á ${destination} ‡πÇ‡∏î‡∏¢‡πÄ‡∏ô‡πâ‡∏ô‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡πÅ‡∏ö‡∏ö: ${stylesText} ‡πÅ‡∏•‡∏∞‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤ (‡∏£‡∏ß‡∏°‡∏£‡∏≠‡∏£‡∏ñ/‡∏ï‡πà‡∏≠‡∏£‡∏ñ), ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ (‡∏´‡∏≤‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ó‡∏≤‡∏á‡∏î‡πà‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°‡∏≠‡∏∑‡πà‡∏ô‡πÜ), ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡πÑ‡∏î‡πâ, ‡πÅ‡∏•‡∏∞‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß, ‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£, ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≤‡πÄ‡∏ü‡πà‡∏ó‡∏µ‡πà‡∏ô‡πà‡∏≤‡∏™‡∏ô‡πÉ‡∏à‡∏ï‡∏≤‡∏°‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á 2-3 ‡πÅ‡∏´‡πà‡∏á‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å`;

            let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];

            const payload = {
                contents: chatHistory,
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            origin: { type: "STRING" },
                            destination: { type: "STRING" },
                            estimatedTravelTime: { type: "STRING" },
                            estimatedCost: { type: "STRING" },
                            travelTypes: { type: "ARRAY", items: { type: "STRING" } },
                            routeSummary: { type: "STRING" },
                            suggestedStops: {
                                type: "OBJECT",
                                properties: {
                                    attractions: { type: "ARRAY", items: { type: "OBJECT", properties: { name: { type: "STRING" }, description: { type: "STRING" } }, required: ["name", "description"] } },
                                    restaurants: { type: "ARRAY", items: { type: "OBJECT", properties: { name: { type: "STRING" }, description: { type: "STRING" } }, required: ["name", "description"] } },
                                    cafes: { type: "ARRAY", items: { type: "OBJECT", properties: { name: { type: "STRING" }, description: { type: "STRING" } }, required: ["name", "description"] } }
                                }, required: ["attractions", "restaurants", "cafes"]
                            }
                        }, required: ["origin", "destination", "estimatedTravelTime", "estimatedCost", "travelTypes", "routeSummary", "suggestedStops"]
                    }
                }
            };
            // API key for Gemini 2.0 Flash - this will be automatically provided by the Canvas environment.
            // DO NOT replace with your actual API key here for GitHub. It should be handled securely as environment variable.
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const result = await response.json();

                if (result.candidates?.[0]?.content?.parts?.[0]) {
                    const parsedJson = JSON.parse(result.candidates[0].content.parts[0].text);
                    setAiSuggestion(parsedJson);

                    const allPlaces = [
                        ...(parsedJson.suggestedStops.attractions || []).map(p => ({ ...p, type: 'attraction', id: `attr-${Math.random().toString(36).substr(2, 9)}` })),
                        ...(parsedJson.suggestedStops.restaurants || []).map(p => ({ ...p, type: 'restaurant', id: `rest-${Math.random().toString(36).substr(2, 9)}` })),
                        ...(parsedJson.suggestedStops.cafes || []).map(p => ({ ...p, type: 'cafe', id: `cafe-${Math.random().toString(36).substr(2, 9)}` }))
                    ];
                    setSuggestedPlaces(allPlaces);
                    setSelectedPlaces([]);
                    setShowTripBuilder(true);
                } else {
                    setAiError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
                    console.log("AI response structure unexpected:", result);
                }
            } catch (error) {
                setAiError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ AI: ' + error.message);
                console.error("Error calling Gemini API:", error);
            } finally {
                setAiLoading(false);
            }
        };

        // --- Handlers for Interactive Trip Builder ---
        const handleSelectPlace = (place) => {
            setSelectedPlaces(prev => [...prev, place]);
        };

        const handleRemovePlace = (placeId) => {
            setSelectedPlaces(prev => prev.filter(p => p.id !== placeId));
        };

        const handleMovePlace = (index, direction) => {
            const newOrder = [...selectedPlaces];
            if (direction === 'up' && index > 0) {
                [newOrder[index], newOrder[index - 1]] = [newOrder[index - 1], newOrder[index]];
            }
            if (direction === 'down' && index < selectedPlaces.length - 1) {
                [newOrder[index], newOrder[index + 1]] = [newOrder[index + 1], newOrder[index]];
            }
            setSelectedPlaces(newOrder);
        };

        const handleLoadMore = async () => {
            // Replaced alert with console.log for better UX
            console.log('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏î‡πâ‡∏ß‡∏¢ AI...');
            const morePlacesPrompt = `‡∏à‡∏≤‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏õ ${destination}, ‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß, ‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£, ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏≤‡πÄ‡∏ü‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏ô‡πà‡∏≤‡∏™‡∏ô‡πÉ‡∏à‡πÅ‡∏•‡∏∞‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏≠‡∏Å‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏à‡∏≤‡∏Å‡πÅ‡∏ú‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏≠‡∏µ‡∏Å 3 ‡πÅ‡∏´‡πà‡∏á`;
            const morePlaces = [
                { id: `extra-attr-${Math.random()}`, name: '‡∏™‡∏ß‡∏ô‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏à‡∏≥‡∏•‡∏≠‡∏á)', description: '‡∏™‡∏ß‡∏ô‡∏™‡∏ß‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô', type: 'attraction' },
                { id: `extra-rest-${Math.random()}`, name: '‡∏£‡πâ‡∏≤‡∏ô‡∏Å‡πã‡∏ß‡∏¢‡πÄ‡∏ï‡∏µ‡πã‡∏¢‡∏ß‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ (‡∏à‡∏≥‡∏•‡∏≠‡∏á)', description: '‡∏Å‡πã‡∏ß‡∏¢‡πÄ‡∏ï‡∏µ‡πã‡∏¢‡∏ß‡πÄ‡∏£‡∏∑‡∏≠‡∏£‡∏™‡πÄ‡∏î‡πá‡∏î', type: 'restaurant' },
            ];
            setSuggestedPlaces(prev => [...prev, ...morePlaces]);
            // Replaced alert with console.log for better UX
            console.log('‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÅ‡∏•‡πâ‡∏ß');
        };

        const handleSummarizeRoute = () => {
            if (selectedPlaces.length < 1) {
                // Replaced alert with console.log for better UX
                console.log('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á');
                return;
            }
            const waypoints = selectedPlaces.map(p => encodeURIComponent(p.name)).join('/');
            const googleMapsUrl = `https://www.google.com/maps/dir/${encodeURIComponent(origin)}/${waypoints}/${encodeURIComponent(destination)}`;

            // Replaced alert with console.log for better UX, and directly open link
            console.log(`‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß! ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î Google Maps...`);
            window.open(googleMapsUrl, '_blank');
            console.log("Generated Route URL:", googleMapsUrl);
        };

        const PlaceIcon = ({ type }) => {
            const icons = {
                attraction: 'üèûÔ∏è',
                restaurant: 'üçú',
                cafe: '‚òï'
            };
            return <span className="text-2xl mr-3">{icons[type] || 'üìç'}</span>;
        };

        return (
            <div className="min-h-screen bg-gray-50 p-6 font-['Prompt']">
                <div className="container mx-auto">
                    {/* AI Travel Planning Section */}
                    <section className="bg-white p-8 rounded-2xl shadow-xl mb-10 border border-blue-200">
                        <h3 className="text-3xl font-semibold text-blue-700 mb-6 border-b pb-3">‡∏£‡∏∞‡∏ö‡∏ö AI ‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div>
                                <label htmlFor="origin" className="block text-gray-700 text-lg font-medium mb-2">‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label>
                                <select
                                    id="origin"
                                    className="w-full p-3 border border-gray-300 rounded-lg text-lg focus:ring-blue-500 focus:border-blue-500"
                                    value={origin}
                                    onChange={(e) => setOrigin(e.target.value)}
                                    required
                                >
                                    <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</option>
                                    {thaiProvinces.map((p, idx) => <option key={idx} value={p}>{p}</option>)}
                                </select>
                            </div>
                            <div>
                                <label htmlFor="destination" className="block text-gray-700 text-lg font-medium mb-2">‡∏à‡∏∏‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á</label>
                                <select
                                    id="destination"
                                    className="w-full p-3 border border-gray-300 rounded-lg text-lg focus:ring-blue-500 focus:border-blue-500"
                                    value={destination}
                                    onChange={(e) => setDestination(e.target.value)}
                                    required
                                >
                                    <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î / ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</option>
                                    {thaiProvinces.map((p, idx) => <option key={idx} value={p}>{p}</option>)}
                                </select>
                            </div>
                        </div>

                        {/* NEW: Trip Style Checkboxes */}
                        <div className="mb-6">
                            <label className="block text-gray-700 text-lg font-medium mb-3">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏Ç‡πâ‡∏≠)</label>
                            <div className="grid grid-cols-2 sm:grid-cols-3 gap-4">
                                {tripStyleOptions.map((style) => (
                                    <label key={style.id}
                                        htmlFor={style.id}
                                        className={`flex items-center p-3 border-2 rounded-lg cursor-pointer transition-all duration-200 ${tripStyles[style.id] ? 'bg-blue-100 border-blue-500 shadow-md' : 'bg-gray-50 hover:bg-gray-100 border-gray-200'}`}>
                                        <input
                                            type="checkbox"
                                            id={style.id}
                                            checked={tripStyles[style.id]}
                                            onChange={() => handleStyleChange(style.id)}
                                            className="h-5 w-5 rounded-md border-gray-300 text-blue-600 focus:ring-blue-500 mr-3"
                                        />
                                        <span className="text-xl mr-2">{style.icon}</span>
                                        <span className={`font-semibold ${tripStyles[style.id] ? 'text-blue-800' : 'text-gray-700'}`}>{style.label}</span>
                                    </label>
                                ))}
                            </div>
                        </div>


                        <button onClick={handleAiPlanTrip} className="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 rounded-xl shadow-lg transition duration-300 hover:scale-[1.01] text-xl" disabled={aiLoading || !destination}>
                            {aiLoading ? <span className="flex items-center justify-center"><svg className="animate-spin h-5 w-5 mr-3 text-white" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô...</span> : '‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏î‡πâ‡∏ß‡∏¢ AI'}
                        </button>

                        {aiError && <p className="text-red-500 text-center mt-4">{aiError}</p>}
                    </section>

                    {/* Interactive Trip Builder UI */}
                    {showTripBuilder && aiSuggestion && (
                        <section className="mt-8 bg-blue-50 bg-opacity-80 p-6 rounded-xl border border-blue-300 animate-fadeIn">
                            <h4 className="text-2xl font-bold text-blue-800 mb-4">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì: {aiSuggestion.origin} ‚Üí {aiSuggestion.destination}</h4>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-lg mb-6 p-4 bg-white rounded-lg shadow">
                                <p><strong>üïí ‡πÄ‡∏ß‡∏•‡∏≤:</strong> {aiSuggestion.estimatedTravelTime}</p>
                                <p><strong>üí∞ ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢:</strong> {aiSuggestion.estimatedCost}</p>
                                <p className="md:col-span-2"><strong>üìù AI ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:</strong> {aiSuggestion.routeSummary}</p>
                            </div>

                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                {/* Left Column: All Suggested Places */}
                                <div className="bg-white p-6 rounded-xl shadow-lg">
                                    <h5 className="text-xl font-bold text-gray-800 mb-4">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h5>
                                    <div className="space-y-4 max-h-96 overflow-y-auto pr-2">
                                        {suggestedPlaces.filter(p => !selectedPlaces.find(sp => sp.id === p.id)).map(place => (
                                            <div key={place.id} className="p-4 border rounded-lg flex items-start relative bg-gray-50 hover:bg-gray-100 transition-colors">
                                                <PlaceIcon type={place.type} />
                                                <div>
                                                    <h6 className="font-bold text-gray-900">{place.name}</h6>
                                                    <p className="text-sm text-gray-600">{place.description}</p>
                                                </div>
                                                <button onClick={() => handleSelectPlace(place)} className="absolute bottom-2 right-2 bg-blue-500 text-white text-xs font-bold py-1 px-3 rounded-full hover:bg-blue-600 transition">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
                                            </div>
                                        ))}
                                    </div>
                                    <button onClick={handleLoadMore} className="w-full mt-4 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg transition">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</button>
                                </div>

                                {/* Right Column: User's Selected Plan */}
                                <div className="bg-white p-6 rounded-xl shadow-lg">
                                    <h5 className="text-xl font-bold text-gray-800 mb-4">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ({selectedPlaces.length})</h5>
                                    <div className="space-y-4 min-h-[24rem] max-h-96 overflow-y-auto pr-2">
                                        {selectedPlaces.length > 0 ? selectedPlaces.map((place, index) => (
                                            <div key={place.id} className="p-4 border rounded-lg flex items-start bg-green-50">
                                                <div className="flex flex-col items-center mr-3">
                                                    <button onClick={() => handleMovePlace(index, 'up')} disabled={index === 0} className="disabled:opacity-25">‚ñ≤</button>
                                                    <span className="font-bold text-lg text-green-700">{index + 1}</span>
                                                    <button onClick={() => handleMovePlace(index, 'down')} disabled={index === selectedPlaces.length - 1} className="disabled:opacity-25">‚ñº</button>
                                                </div>
                                                <div className="flex-grow">
                                                    <h6 className="font-bold text-gray-900">{place.name}</h6>
                                                    <p className="text-sm text-gray-600">{place.description}</p>
                                                </div>
                                                <button onClick={() => handleRemovePlace(place.id)} className="text-red-500 hover:text-red-700 font-bold text-xl ml-2">√ó</button>
                                            </div>
                                        )) : (
                                            <div className="flex items-center justify-center h-full text-gray-500">
                                                <p>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≤‡∏Å "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
                                            </div>
                                        )}
                                    </div>
                                    {selectedPlaces.length > 0 && (
                                         <button onClick={handleSummarizeRoute} className="w-full mt-4 bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg transition text-lg">‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á</button>
                                    )}
                                </div>
                            </div>
                        </section>
                    )}

                    {/* Travel Calculation / Comparison Section */}
                    <section className="bg-white p-8 rounded-2xl shadow-xl border border-green-200 mt-10">
                        <h3 className="text-3xl font-semibold text-green-700 mb-6 border-b pb-3">‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á (‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö)</h3>
                        {/* Content from original component... */}
                        <p className="text-gray-600">‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ ‡∏ã‡∏∂‡πà‡∏á‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï</p>
                    </section>
                </div>
            </div>
        );
    };

    // Tourist Attractions Page (MODIFIED)
    const AttractionsPage = ({ db, auth, user, userId, isAuthReady, appId }) => { // Receive Firebase props
        const [searchTerm, setSearchTerm] = useState('');
        const [selectedProvince, setSelectedProvince] = useState('');
        const [selectedType, setSelectedType] = useState('');
        const [attractions, setAttractions] = useState([]);
        const [loading, setLoading] = useState(true);
        const [error, setError] = useState('');
        const [currentFestivalSlide, setCurrentFestivalSlide] = useState(0);
        const [selectedAttraction, setSelectedAttraction] = useState(null); // New state for selected attraction detail

        // Festival slideshow timer
        useEffect(() => {
            const timer = setInterval(() => {
                setCurrentFestivalSlide(prev => (prev + 1) % mockFestivals.length);
            }, 5000); // Change slide every 5 seconds
            return () => clearInterval(timer);
        }, []);


        useEffect(() => {
            if (!db || !isAuthReady) return; // Wait for Firebase to be ready

            const publicAttractionsRef = collection(db, `artifacts/${appId}/public/data/attractions`);

            const unsubscribe = onSnapshot(publicAttractionsRef, (snapshot) => {
                const fetchedAttractions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                setAttractions(fetchedAttractions);
                setLoading(false);
            }, (err) => {
                setError('Failed to fetch attractions: ' + err.message);
                setLoading(false);
            });

            // Initial population if no data exists
            if (mockAttractions.length > 0) {
                // Check if collection is empty, then add mock data
                getDocs(publicAttractionsRef).then(snapshot => {
                    if (snapshot.empty) {
                        mockAttractions.forEach(async (attr) => {
                            try {
                                // Ensure document ID is set to attr.id for consistent data
                                await setDoc(doc(publicAttractionsRef, attr.id), attr);
                                console.log(`Added mock attraction: ${attr.name}`);
                            } catch (e) {
                                console.error("Error adding mock attraction: ", e);
                            }
                        });
                    }
                }).catch(e => console.error("Error checking attractions collection:", e));
            }

            return () => unsubscribe();
        }, [db, isAuthReady, userId, appId]); // Added appId to dependency array

        const filteredAttractions = attractions.filter(attraction => {
            const matchesSearch = attraction.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                                  attraction.description.toLowerCase().includes(searchTerm.toLowerCase()) ||
                                  attraction.province.toLowerCase().includes(searchTerm.toLowerCase());
            const matchesProvince = selectedProvince === '' || attraction.province === selectedProvince;
            const matchesType = selectedType === '' || attraction.type === selectedType;
            return matchesSearch && matchesProvince && matchesType;
        });

        // For now, we will display all mock festivals as "current and future"
        const upcomingFestivals = mockFestivals;


        if (loading) return <div className="text-center p-8 font-['Prompt'] text-xl">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>;
        if (error) return <div className="text-center p-8 font-['Prompt'] text-xl text-red-600">{error}</div>;

        // Render AttractionDetailView if an attraction is selected
        if (selectedAttraction) {
            return (
                <AttractionDetailView
                    attraction={selectedAttraction}
                    onBack={() => setSelectedAttraction(null)}
                    db={db}
                    auth={auth}
                    user={user}
                    userId={userId}
                    isAuthReady={isAuthReady}
                    appId={appId}
                />
            );
        }

        return (
            <div className="min-h-screen bg-gray-50 p-4 md:p-6 font-['Prompt']">
                <div className="container mx-auto">
                    <h2 className="text-3xl md:text-4xl font-bold text-gray-800 mb-6 text-center">‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏ó‡∏¢</h2>

                    {/* NEW: Festivals Section */}
                    <section className="mb-12">
                        <h3 className="text-2xl md:text-3xl font-bold text-blue-700 mb-6 text-center">üéâ ‡∏á‡∏≤‡∏ô‡πÄ‡∏ó‡∏®‡∏Å‡∏≤‡∏•‡∏ó‡∏µ‡πà‡∏ô‡πà‡∏≤‡∏™‡∏ô‡πÉ‡∏à‡∏ó‡∏±‡πà‡∏ß‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®</h3>

                        {/* Animated Slideshow */}
                        <div className="relative w-full max-w-4xl mx-auto h-64 md:h-96 rounded-2xl shadow-2xl overflow-hidden mb-8">
                            <div
                                className="flex transition-transform duration-700 ease-in-out h-full"
                                style={{ transform: `translateX(-${currentFestivalSlide * 100}%)` }}
                            >
                                {mockFestivals.map((festival) => (
                                    <div key={festival.id} className="w-full flex-shrink-0 relative h-full">
                                        <img
                                            src={festival.image}
                                            alt={festival.name}
                                            className="absolute inset-0 w-full h-full object-cover"
                                            onError={(e) => { e.target.onerror = null; e.target.src="https://placehold.co/600x400/CCCCCC/FFFFFF?text=Image+Error"; }}
                                        />
                                        <div className="absolute inset-0 bg-gradient-to-t from-black/70 to-transparent flex flex-col justify-end p-4 md:p-8 text-white">
                                            <h4 className="text-2xl md:text-4xl font-bold mb-2 drop-shadow-lg">{festival.name}</h4>
                                            <p className="text-base md:text-lg drop-shadow-md">{festival.description}</p>
                                            <p className="text-sm md:text-base mt-2">üìç {festival.location}</p>
                                        </div>
                                    </div>
                                ))}
                            </div>
                            {/* Dots for navigation */}
                            <div className="absolute bottom-4 left-1/2 -translate-x-1/2 flex space-x-2">
                                {mockFestivals.map((_, idx) => (
                                    <button
                                        key={idx}
                                        onClick={() => setCurrentFestivalSlide(idx)}
                                        className={`w-3 h-3 rounded-full transition-colors duration-300 ${currentFestivalSlide === idx ? 'bg-white' : 'bg-white/50'}`}
                                    />
                                ))}
                            </div>
                        </div>

                        {/* Upcoming Festivals List */}
                        <div className="space-y-6">
                            {upcomingFestivals.map(festival => (
                                <div key={festival.id} className="bg-white rounded-2xl shadow-lg overflow-hidden flex flex-col md:flex-row items-center transform transition-all duration-300 hover:scale-[1.02] hover:shadow-xl">
                                    <img
                                        src={festival.image}
                                        alt={festival.name}
                                        className="w-full md:w-1/3 h-48 md:h-full object-cover"
                                        onError={(e) => { e.target.onerror = null; e.target.src="https://placehold.co/400x250/E0E0E0/000?text=No+Image"; }}
                                    />
                                    <div className="p-6 flex-1">
                                        <h4 className="text-2xl font-bold text-gray-800 mb-2">{festival.name}</h4>
                                        <p className="text-gray-600 mb-2"><strong>üóìÔ∏è ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong> {festival.dates}</p>
                                        <p className="text-gray-600 mb-2"><strong>‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤:</strong> {festival.time}</p>
                                        <p className="text-gray-600 mb-4">
                                            <strong>üìç ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà:</strong> {festival.location}
                                            <a href={festival.googleMapsLink} target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:underline ml-2 font-semibold">(‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà)</a>
                                        </p>
                                        <button
                                            onClick={() => console.log(`‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô ${festival.name}`)} // Replaced alert
                                            className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-full transition duration-300 shadow-md hover:shadow-lg"
                                        >
                                            ‡∏î‡∏π‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
                                        </button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </section>

                    <hr className="my-12 border-t-2 border-gray-200" />

                    {/* Attractions Section */}
                    <h3 className="text-2xl md:text-3xl font-bold text-green-700 mb-6 text-center">üèûÔ∏è ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß</h3>
                    {/* Search & Filter */}
                    <div className="bg-white p-6 rounded-2xl shadow-xl mb-8 flex flex-col md:flex-row gap-4 items-center sticky top-0 z-10">
                        <input
                            type="text"
                            placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà / ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î (‡πÄ‡∏ä‡πà‡∏ô ‡∏ó‡∏∞‡πÄ‡∏•, ‡∏ß‡∏±‡∏î)"
                            className="flex-grow p-3 border border-gray-300 rounded-lg text-lg focus:ring-blue-500 focus:border-blue-500"
                            value={searchTerm}
                            onChange={(e) => setSearchTerm(e.target.value)}
                        />
                        <select
                            className="p-3 border border-gray-300 rounded-lg text-lg focus:ring-blue-500 focus:border-blue-500 w-full md:w-auto"
                            value={selectedProvince}
                            onChange={(e) => setSelectedProvince(e.target.value)}
                        >
                            <option value="">‡∏ó‡∏∏‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</option>
                            {thaiProvinces.map((p, idx) => <option key={idx} value={p}>{p}</option>)}
                        </select>
                        <select
                            className="p-3 border border-gray-300 rounded-lg text-lg focus:ring-blue-500 focus:border-blue-500 w-full md:w-auto"
                            value={selectedType}
                            onChange={(e) => setSelectedType(e.target.value)}
                        >
                            <option value="">‡∏ó‡∏∏‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</option>
                            <option value="‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥">‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥</option>
                            <option value="‡∏ß‡∏±‡∏í‡∏ô‡∏ò‡∏£‡∏£‡∏°">‡∏ß‡∏±‡∏í‡∏ô‡∏ò‡∏£‡∏£‡∏°</option>
                            <option value="‡∏ä‡πâ‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á & ‡∏ï‡∏•‡∏≤‡∏î">‡∏ä‡πâ‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á & ‡∏ï‡∏•‡∏≤‡∏î</option>
                            <option value="‡∏™‡∏ß‡∏ô‡∏™‡∏ô‡∏∏‡∏Å & ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°">‡∏™‡∏ß‡∏ô‡∏™‡∏ô‡∏∏‡∏Å & ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</option>
                        </select>
                    </div>

                    {/* Attractions Grid */}
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                        {filteredAttractions.length > 0 ? filteredAttractions.map(attraction => (
                            <div
                                key={attraction.id}
                                className="bg-white rounded-2xl shadow-lg overflow-hidden border border-gray-200 transform transition duration-300 hover:scale-[1.02] hover:shadow-xl cursor-pointer"
                                onClick={() => setSelectedAttraction(attraction)} // Set selected attraction on click
                            >
                                <img
                                    src={attraction.images[0]}
                                    alt={attraction.name}
                                    className="w-full h-48 object-cover"
                                    onError={(e) => { e.target.onerror = null; e.target.src="https://placehold.co/400x250/E0E0E0/000?text=No+Image"; }}
                                />
                                <div className="p-5">
                                    <h3 className="text-xl font-bold text-gray-800 mb-2">{attraction.name} ({attraction.province})</h3>
                                    <p className="text-gray-600 text-sm mb-3 line-clamp-3">{attraction.description}</p>
                                    <p className="text-gray-700 text-sm mb-1">‚è∞ ‡πÄ‡∏õ‡∏¥‡∏î-‡∏õ‡∏¥‡∏î: {attraction.openingHours}</p>
                                    <p className="text-gray-700 text-sm mb-3">
                                        üí∏ ‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°: {attraction.fee}
                                    </p>
                                    <div className="flex items-center text-yellow-500 mb-3">
                                        {'‚≠ê'.repeat(Math.round(attraction.reviews.avg))} ({attraction.reviews.avg}) - {attraction.reviews.count} ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß
                                    </div>
                                    <a href={attraction.mapLink} target="_blank" rel="noopener noreferrer" className="block text-blue-600 hover:underline text-sm font-semibold">
                                        üìç ‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
                                    </a>
                                </div>
                            </div>
                        )) : (
                            <p className="col-span-full text-center text-gray-600 text-lg">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç</p>
                        )}
                    </div>
                </div>
            </div>
        );
    };

    // NEW: Attraction Detail View Component
    const AttractionDetailView = ({ attraction, onBack, db, auth, user, userId, isAuthReady, appId }) => {
        const [currentImageIndex, setCurrentImageIndex] = useState(0);
        const [reviewText, setReviewText] = useState('');
        const [starRating, setStarRating] = useState(0);
        const [submitLoading, setSubmitLoading] = useState(false);
        const [submitError, setSubmitError] = useState('');
        const [attractionReviews, setAttractionReviews] = useState([]);
        const [reviewsLoading, setReviewsLoading] = useState(true);
        const [reviewsError, setReviewsError] = useState('');
        const [summaries, setSummaries] = useState({}); // To store AI summaries for each review
        const [summaryLoading, setSummaryLoading] = useState({}); // Loading state for summaries

        // Function for AI content moderation (copied from ReviewsPage for local use)
        const checkReviewSafety = useCallback(async (text) => {
            if (!text.trim()) return { is_safe: true, reason: 'No text to check.' };

            const prompt = `‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏¢‡∏≤‡∏ö‡∏Ñ‡∏≤‡∏¢ ‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á ‡πÇ‡∏Ü‡∏©‡∏ì‡∏≤‡πÅ‡∏ù‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô JSON ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏∞‡∏ö‡∏∏ 'is_safe': true/false ‡πÅ‡∏•‡∏∞ 'reason': '‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•' \n\n‡∏£‡∏µ‡∏ß‡∏¥‡∏ß: "${text}"`;
            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });

            const payload = {
                contents: chatHistory,
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "is_safe": { "type": "BOOLEAN" },
                            "reason": { "type": "STRING" }
                        },
                        "propertyOrdering": ["is_safe", "reason"]
                    }
                }
            };
            const apiKey = ""; // Canvas will provide this. Do not set your actual key here.
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const jsonString = result.candidates[0].content.parts[0].text;
                    return JSON.parse(jsonString);
                } else {
                    console.warn("AI moderation response unexpected:", result);
                    return { is_safe: true, reason: 'AI response inconclusive, proceeding with caution.' };
                }
            } catch (error) {
                console.error("Error calling Gemini API for moderation:", error);
                return { is_safe: true, reason: 'AI moderation failed, proceeding without check.' };
            }
        }, []); // Empty dependency array means this function is memoized and won't re-create unless deps change

        // Function for AI review summarization (copied from ReviewsPage for local use)
        const getReviewSummary = useCallback(async (reviewId, text) => {
            if (summaries[reviewId]) return; // Already summarized
            setSummaryLoading(prev => ({ ...prev, [reviewId]: true }));

            const prompt = `‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡πÑ‡∏î‡πâ‡πÉ‡∏à‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡πÉ‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢:\n\n"${text}"`;
            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });

            const payload = {
                contents: chatHistory,
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "summary": { "type": "STRING" }
                        },
                        "propertyOrdering": ["summary"]
                    }
                }
            };
            const apiKey = ""; // Canvas will provide this. Do not set your actual key here.
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const jsonString = result.candidates[0].content.parts[0].text;
                    const parsedJson = JSON.parse(jsonString);
                    setSummaries(prev => ({ ...prev, [reviewId]: parsedJson.summary }));
                } else {
                    setSummaries(prev => ({ ...prev, [reviewId]: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡πÑ‡∏î‡πâ' }));
                    console.warn("AI summary response unexpected:", result);
                }
            } catch (error) {
                setSummaries(prev => ({ ...prev, [reviewId]: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡∏∏‡∏õ' }));
                console.error("Error calling Gemini API for summary:", error);
            } finally {
                setSummaryLoading(prev => ({ ...prev, [reviewId]: false }));
            }
        }, [summaries]); // summaries as dependency to prevent infinite loop

        // Fetch reviews for this specific attraction
        useEffect(() => {
            if (!db || !isAuthReady || !attraction?.id) return;

            setReviewsLoading(true);
            const reviewsCollectionRef = collection(db, `artifacts/${appId}/public/data/reviews`);
            // Query reviews where attractionId matches the current attraction's ID
            const q = query(reviewsCollectionRef, where("attractionId", "==", attraction.id));

            const unsubscribe = onSnapshot(q, (snapshot) => {
                const fetchedReviews = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                setAttractionReviews(fetchedReviews.sort((a, b) => b.timestamp?.toDate() - a.timestamp?.toDate())); // Sort by latest
                setReviewsLoading(false);
            }, (err) => {
                setReviewsError('Failed to fetch reviews: ' + err.message);
                setReviewsLoading(false);
                console.error("Error fetching attraction reviews:", err);
            });

            return () => unsubscribe();
        }, [db, isAuthReady, attraction, appId]); // Re-fetch when attraction or firebase state changes

        const handleNextImage = () => {
            setCurrentImageIndex((prevIndex) => (prevIndex + 1) % attraction.images.length);
        };

        const handlePrevImage = () => {
            setCurrentImageIndex((prevIndex) => (prevIndex - 1 + attraction.images.length) % attraction.images.length);
        };

        const handleSubmitReview = async () => {
            if (!user || userId === 'anonymous') {
                setSubmitError('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏£‡∏µ‡∏ß‡∏¥‡∏ß');
                return;
            }
            if (!reviewText.trim()) {
                setSubmitError('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏£‡∏µ‡∏ß‡∏¥‡∏ß');
                return;
            }
            if (starRating === 0) {
                setSubmitError('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏µ‡∏ß‡∏¥‡∏ß');
                return;
            }

            setSubmitLoading(true);
            setSubmitError('');

            const moderationResult = await checkReviewSafety(reviewText);
            if (!moderationResult.is_safe) {
                setSubmitError(`‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°: ${moderationResult.reason}`);
                setSubmitLoading(false);
                return;
            }

            try {
                const reviewsCollectionRef = collection(db, `artifacts/${appId}/public/data/reviews`);
                const newReview = {
                    attractionId: attraction.id, // Link review to this attraction
                    reviewerId: userId,
                    reviewerName: user.displayName || user.email || `‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ${userId.substring(0, 8)}...`,
                    reviewerProfilePic: 'https://placehold.co/50x50/B0B0B0/000?text=üë§', // Placeholder
                    text: reviewText,
                    images: [], // No image/video upload for simplicity in this specific section
                    videos: [],
                    rating: starRating,
                    timestamp: Timestamp.now(), // Use Firebase Timestamp
                    likes: 0,
                    comments: 0,
                    shares: 0
                };

                await addDoc(reviewsCollectionRef, newReview);
                // Replaced alert with console.log for better UX
                console.log('‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÅ‡∏•‡πâ‡∏ß!');
                setReviewText('');
                setStarRating(0);
            } catch (err) {
                setSubmitError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏£‡∏µ‡∏ß‡∏¥‡∏ß: ' + err.message);
                console.error("Error submitting review:", err);
            } finally {
                setSubmitLoading(false);
            }
        };


        if (!attraction) return <div className="text-center p-8 font-['Prompt'] text-xl">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß</div>;

        return (
            <div className="min-h-screen bg-gray-50 p-4 md:p-6 font-['Prompt']">
                <div className="container mx-auto bg-white rounded-2xl shadow-xl p-6 md:p-8">
                    <button
                        onClick={onBack}
                        className="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-full mb-6 transition duration-300 flex items-center"
                    >
                        <svg className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
                        ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà
                    </button>

                    <h1 className="text-3xl md:text-5xl font-bold text-gray-800 mb-4 text-center">{attraction.name}</h1>
                    <p className="text-lg text-gray-600 mb-6 text-center">{attraction.province}</p>

                    {/* Image Gallery/Slideshow */}
                    {attraction.images && attraction.images.length > 0 && (
                        <div className="relative w-full max-w-3xl mx-auto mb-8 rounded-xl overflow-hidden shadow-lg border border-gray-200">
                            <img
                                src={attraction.images[currentImageIndex]}
                                alt={attraction.name}
                                className="w-full h-80 md:h-96 object-cover"
                                onError={(e) => { e.target.onerror = null; e.target.src="https://placehold.co/800x600/CCCCCC/FFFFFF?text=Image+Error"; }}
                            />
                            {attraction.images.length > 1 && (
                                <>
                                    <button
                                        onClick={handlePrevImage}
                                        className="absolute left-4 top-1/2 -translate-y-1/2 bg-black bg-opacity-50 text-white p-2 rounded-full hover:bg-opacity-75 transition-colors duration-300"
                                    >
                                        &lt;
                                    </button>
                                    <button
                                        onClick={handleNextImage}
                                        className="absolute right-4 top-1/2 -translate-y-1/2 bg-black bg-opacity-50 text-white p-2 rounded-full hover:bg-opacity-75 transition-colors duration-300"
                                    >
                                        &gt;
                                    </button>
                                    <div className="absolute bottom-4 left-1/2 -translate-x-1/2 flex space-x-2">
                                        {attraction.images.map((_, idx) => (
                                            <button
                                                key={idx}
                                                onClick={() => setCurrentImageIndex(idx)}
                                                className={`h-2.5 w-2.5 rounded-full ${currentImageIndex === idx ? 'bg-white' : 'bg-gray-400'} transition-colors duration-300`}
                                            ></button>
                                        ))}
                                    </div>
                                </>
                            )}
                        </div>
                    )}

                    {/* Detailed Information */}
                    <section className="mb-8 p-4 md:p-6 bg-blue-50 rounded-xl border border-blue-200">
                        <h2 className="text-2xl md:text-3xl font-semibold text-blue-800 mb-4">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å</h2>
                        <p className="text-gray-700 text-base md:text-lg mb-3">
                            <strong>‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö:</strong> {attraction.description}
                        </p>
                        {attraction.history && (
                            <p className="text-gray-700 text-base md:text-lg mb-3">
                                <strong>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥:</strong> {attraction.history}
                            </p>
                        )}
                        {attraction.significance && (
                            <p className="text-gray-700 text-base md:text-lg mb-3">
                                <strong>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç:</strong> {attraction.significance}
                            </p>
                        )}
                        <p className="text-gray-700 text-base md:text-lg mb-1">
                            <strong>‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡∏¥‡∏î-‡∏õ‡∏¥‡∏î:</strong> {attraction.openingHours}
                        </p>
                        <p className="text-gray-700 text-base md:text-lg mb-3">
                            <strong>üí∏ ‡∏Ñ‡πà‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏°:</strong> {attraction.fee}
                        </p>
                        <a href={attraction.mapLink} target="_blank" rel="noopener noreferrer" className="inline-flex items-center text-blue-600 hover:underline font-semibold text-base md:text-lg">
                            <svg className="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                            ‡∏î‡∏π‡∏ö‡∏ô Google Maps
                        </a>
                    </section>

                    {/* Review Section */}
                    <section className="mt-8 p-4 md:p-6 bg-purple-50 rounded-xl border border-purple-200">
                        <h2 className="text-2xl md:text-3xl font-semibold text-purple-800 mb-6">‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ({attraction.name})</h2>

                        {/* Review Submission Form */}
                        <div className="mb-8 p-4 bg-white rounded-xl shadow-md border border-gray-200">
                            <h3 className="text-xl font-semibold text-gray-800 mb-4">‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</h3>
                            <textarea
                                className="w-full p-3 border border-gray-300 rounded-lg text-base focus:ring-purple-500 focus:border-purple-500 resize-y min-h-[80px]"
                                placeholder="‡πÅ‡∏ä‡∏£‡πå‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."
                                value={reviewText}
                                onChange={(e) => setReviewText(e.target.value)}
                            ></textarea>
                            <div className="mt-3 flex items-center gap-4">
                                <div>
                                    <label className="block text-gray-700 text-sm font-medium mb-1">‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô:</label>
                                    <div className="flex space-x-1">
                                        {[1, 2, 3, 4, 5].map((star) => (
                                            <span
                                                key={star}
                                                className={`text-3xl cursor-pointer transition-colors duration-200 ${star <= starRating ? 'text-yellow-500' : 'text-gray-300'}`}
                                                onClick={() => setStarRating(star)}
                                            >
                                                ‚≠ê
                                            </span>
                                        ))}
                                    </div>
                                </div>
                            </div>
                            {submitError && <p className="text-red-500 text-center mt-3 text-sm">{submitError}</p>}
                            <button
                                onClick={handleSubmitReview}
                                className="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 rounded-xl shadow-lg mt-5 transition duration-300 text-lg"
                                disabled={submitLoading || !reviewText.trim() || starRating === 0}
                            >
                                {submitLoading ? (
                                    <span className="flex items-center justify-center">
                                        <svg className="animate-spin h-5 w-5 mr-3 text-white" viewBox="0 0 24 24">
                                            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                        ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏û‡∏™‡∏ï‡πå...
                                    </span>
                                ) : (
                                    '‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏£‡∏µ‡∏ß‡∏¥‡∏ß'
                                )}
                            </button>
                        </div>

                        {/* Existing Reviews */}
                        {reviewsLoading ? (
                            <div className="text-center text-gray-600 text-lg">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏µ‡∏ß‡∏¥‡∏ß...</div>
                        ) : reviewsError ? (
                            <div className="text-center text-red-600 text-lg">{reviewsError}</div>
                        ) : attractionReviews.length > 0 ? (
                            <div className="space-y-6">
                                {attractionReviews.map(review => (
                                    <div key={review.id} className="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                                        <div className="flex items-center mb-4">
                                            <img src={review.reviewerProfilePic} alt={review.reviewerName} className="w-10 h-10 rounded-full mr-3" />
                                            <div>
                                                <p className="font-bold text-base text-gray-800">{review.reviewerName}</p>
                                                <p className="text-gray-500 text-xs">{review.timestamp?.toDate().toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
                                            </div>
                                        </div>
                                        <div className="flex items-center text-yellow-500 mb-3 text-lg">
                                            {'‚≠ê'.repeat(Math.round(review.rating))} ({review.rating})
                                        </div>
                                        <p className="text-gray-700 text-sm mb-4">{review.text}</p>
                                        {/* AI Summary Button */}
                                        {review.text && (
                                            <div className="mt-4">
                                                <button
                                                    onClick={() => getReviewSummary(review.id, review.text)}
                                                    className="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-full text-xs flex items-center justify-center transition duration-300"
                                                    disabled={summaryLoading[review.id]}
                                                >
                                                    {summaryLoading[review.id] ? (
                                                        <svg className="animate-spin h-4 w-4 mr-2" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                                    ) : (
                                                        '‚ú® ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏î‡πâ‡∏ß‡∏¢ AI'
                                                    )}
                                                </button>
                                                {summaries[review.id] && (
                                                    <p className="mt-2 text-gray-700 text-xs bg-gray-100 p-2 rounded-md border border-gray-200">
                                                        <strong>‡∏™‡∏£‡∏∏‡∏õ:</strong> {summaries[review.id]}
                                                    </p>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>
                        ) : (
                            <p className="text-center text-gray-600 text-lg">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ</p>
                        )}
                    </section>
                </div>
            </div>
        );
    };

    // Restaurants Page
    const RestaurantsPage = () => {
        const [searchTerm, setSearchTerm] = useState('');
        const [selectedProvince, setSelectedProvince] = useState('');
        const [selectedFoodType, setSelectedFoodType] = useState('');
        const [restaurants, setRestaurants] = useState([]);
        const [loading, setLoading] = useState(true);
        const [error, setError] = useState('');
        const [bookmarkedRestaurants, setBookmarkedRestaurants] = useState([]);

        const publicRestaurantsRef = db ? collection(db, `artifacts/${appId}/public/data/restaurants`) : null;
        const privateBookmarksRef = db && userId !== 'anonymous' ? collection(db, `artifacts/${appId}/users/${userId}/bookmarkedRestaurants`) : null;

        useEffect(() => {
            if (!db || !isAuthReady || !publicRestaurantsRef) {
                // If Firebase is not ready or no public ref, set loading to false and return.
                // This means data won't be fetched, but the UI won't be stuck loading.
                setLoading(false);
                return;
            };

            const unsubscribeRestaurants = onSnapshot(publicRestaurantsRef, (snapshot) => {
                const fetchedRestaurants = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                setRestaurants(fetchedRestaurants);
                setLoading(false);
            }, (err) => {
                setError('Failed to fetch restaurants: ' + err.message);
                setLoading(false);
            });

            // Add mock data if collection is empty
            getDocs(publicRestaurantsRef).then(snapshot => {
                if (snapshot.empty) {
                    mockRestaurants.forEach(async (res) => {
                        try {
                            await setDoc(doc(publicRestaurantsRef, res.id), res);
                            console.log(`Added mock restaurant: ${res.name}`);
                        } catch (e) {
                            console.error("Error adding mock restaurant: ", e);
                        }
                    });
                }
            }).catch(e => console.error("Error checking restaurants collection:", e));

            return () => unsubscribeRestaurants();
        }, [db, isAuthReady, userId, appId, publicRestaurantsRef]); // Added publicRestaurantsRef to dependency array

        useEffect(() => {
            if (!db || !isAuthReady || !privateBookmarksRef || userId === 'anonymous') {
                setBookmarkedRestaurants([]); // Clear bookmarks if not authenticated or anonymous
                return;
            }

            const unsubscribeBookmarks = onSnapshot(privateBookmarksRef, (snapshot) => {
                const bookmarks = snapshot.docs.map(doc => doc.id); // Store only IDs of bookmarked restaurants
                setBookmarkedRestaurants(bookmarks);
            }, (err) => {
                console.error("Failed to fetch bookmarks:", err);
            });

            return () => unsubscribeBookmarks();
        }, [db, isAuthReady, userId, appId, privateBookmarksRef]); // Added privateBookmarksRef to dependency array

        const toggleBookmark = async (restaurantId) => {
            if (!privateBookmarksRef || userId === 'anonymous') {
                // Replaced alert with console.log
                console.log('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡πâ‡∏≤‡∏ô‡πÇ‡∏õ‡∏£‡∏î');
                return;
            }

            const bookmarkDocRef = doc(privateBookmarksRef, restaurantId);
            const isBookmarked = bookmarkedRestaurants.includes(restaurantId);

            try {
                if (isBookmarked) {
                    await deleteDoc(bookmarkDocRef);
                    console.log(`Removed bookmark for ${restaurantId}`);
                } else {
                    await setDoc(bookmarkDocRef, { timestamp: new Date() }); // Store a timestamp
                    console.log(`Added bookmark for ${restaurantId}`);
                }
            } catch (e) {
                console.error("Error toggling bookmark:", e);
                // Replaced alert with console.log
                console.log('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡πâ‡∏≤‡∏ô‡πÇ‡∏õ‡∏£‡∏î');
            }
        };

        const filteredRestaurants = restaurants.filter(restaurant => {
            const matchesSearch = restaurant.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                                  restaurant.type.toLowerCase().includes(searchTerm.toLowerCase()) ||
                                  restaurant.popularMenus.some(menu => menu.name.toLowerCase().includes(searchTerm.toLowerCase()));
            const matchesProvince = selectedProvince === '' || restaurant.province === selectedProvince;
            const matchesFoodType = selectedFoodType === '' || restaurant.type === selectedFoodType;
            // Add more filter logic for price range, parking, etc.
            return matchesSearch && matchesProvince && matchesFoodType;
        });

        if (loading) return <div className="text-center p-8 font-['Prompt'] text-xl">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£...</div>;
        if (error) return <div className="text-center p-8 font-['Prompt'] text-xl text-red-600">{error}</div>;

        return (
            <div className="min-h-screen bg-gray-50 p-6 font-['Prompt']">
                <div className="container mx-auto">
                    <h2 className="text-4xl font-bold text-gray-800 mb-8 text-center">‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏î‡πá‡∏î‡∏î‡∏±‡∏á‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏ó‡∏¢</h2>

                    {/* Search & Filter */}
                    <div className="bg-white p-6 rounded-2xl shadow-xl mb-8 flex flex-col md:flex-row gap-4 items-center">
                        <input
                            type="text"
                            placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô, ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏≠‡∏≤‡∏´‡∏≤‡∏£, ‡πÄ‡∏°‡∏ô‡∏π"
                            className="flex-grow p-3 border border-gray-300 rounded-lg text-lg focus:ring-red-500 focus:border-red-500"
                            value={searchTerm}
                            onChange={(e) => setSearchTerm(e.target.value)}
                        />
                        <select
                            className="p-3 border border-gray-300 rounded-lg text-lg focus:ring-red-500 focus:border-red-500 w-full md:w-auto"
                            value={selectedProvince}
                            onChange={(e) => setSelectedProvince(e.target.value)}
                        >
                            <option value="">‡∏ó‡∏∏‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</option>
                            {thaiProvinces.map((p, idx) => <option key={idx} value={p}>{p}</option>)}
                        </select>
                        <select
                            className="p-3 border border-gray-300 rounded-lg text-lg focus:ring-red-500 focus:border-red-500 w-full md:w-auto"
                            value={selectedFoodType}
                            onChange={(e) => setSelectedFoodType(e.target.value)}
                        >
                            <option value="">‡∏ó‡∏∏‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏≠‡∏≤‡∏´‡∏≤‡∏£</option>
                            <option value="‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏û‡∏∑‡πâ‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á">‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏û‡∏∑‡πâ‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á</option>
                            <option value="‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏∞‡πÄ‡∏•">‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏∞‡πÄ‡∏•</option>
                            <option value="‡∏Ç‡∏ô‡∏°‡∏´‡∏ß‡∏≤‡∏ô">‡∏Ç‡∏ô‡∏°‡∏´‡∏ß‡∏≤‡∏ô</option>
                            <option value="‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏à">‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏à</option>
                            {/* More food types */}
                        </select>
                        {/* More filters */}
                    </div>

                    {/* Restaurants Grid */}
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                        {filteredRestaurants.length > 0 ? filteredRestaurants.map(restaurant => (
                            <div key={restaurant.id} className="bg-white rounded-2xl shadow-lg overflow-hidden border border-gray-200 transform transition duration-300 hover:scale-[1.02] hover:shadow-xl relative">
                                <button
                                    className="absolute top-4 right-4 text-3xl z-10"
                                    onClick={() => toggleBookmark(restaurant.id)}
                                    aria-label="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡πâ‡∏≤‡∏ô‡πÇ‡∏õ‡∏£‡∏î"
                                >
                                    {bookmarkedRestaurants.includes(restaurant.id) ? '‚ù§Ô∏è' : 'ü§ç'}
                                </button>
                                <img
                                    src={restaurant.images[0]}
                                    alt={restaurant.name}
                                    className="w-full h-48 object-cover"
                                    onError={(e) => { e.target.onerror = null; e.target.src="https://placehold.co/400x250/E0E0E0/000?text=No+Image"; }}
                                />
                                <div className="p-5">
                                    <h3 className="text-xl font-bold text-gray-800 mb-2">{restaurant.name} ({restaurant.province})</h3>
                                    <p className="text-gray-600 text-sm mb-3">
                                        üìç <a href={restaurant.googleMapsLink} target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:underline">
                                            {restaurant.locationDetail}
                                        </a>
                                    </p>
                                    <p className="text-gray-700 text-sm mb-1">‚è∞ ‡πÄ‡∏õ‡∏¥‡∏î-‡∏õ‡∏¥‡∏î: {restaurant.openingHours}</p>
                                    <p className="text-gray-700 text-sm mb-3">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: {restaurant.type} | ‡∏ä‡πà‡∏ß‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤: {restaurant.priceRange}</p>

                                    {restaurant.popularMenus && restaurant.popularMenus.length > 0 && (
                                        <div className="mb-3">
                                            <h4 className="font-semibold text-gray-700">‡πÄ‡∏°‡∏ô‡∏π‡∏¢‡∏≠‡∏î‡∏Æ‡∏¥‡∏ï:</h4>
                                            <div className="flex flex-wrap gap-2 mt-1">
                                                {restaurant.popularMenus.map((menu, idx) => (
                                                    <span key={idx} className="bg-gray-100 rounded-full px-3 py-1 text-sm text-gray-700">
                                                        {menu.name} ({menu.price})
                                                    </span>
                                                ))}
                                            </div>
                                        </div>
                                    )}

                                    <div className="flex items-center text-yellow-500 mb-3">
                                        {'‚≠ê'.repeat(Math.round(restaurant.reviews.avg))} ({restaurant.reviews.avg}) - {restaurant.reviews.count} ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß
                                    </div>
                                    {restaurant.userComments && restaurant.userComments.length > 0 && (
                                        <div className="border-t pt-3 mt-3">
                                            <h4 className="font-semibold text-gray-700 mb-2">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÑ‡∏õ‡∏•‡∏¥‡πâ‡∏°‡∏•‡∏≠‡∏á:</h4>
                                            {restaurant.userComments.map((comment, idx) => (
                                                <div key={idx} className="flex items-start mb-2">
                                                    <img src={comment.image} alt={comment.user} className="w-8 h-8 rounded-full mr-2" />
                                                    <div>
                                                        <p className="font-semibold text-gray-800 text-sm">{comment.user}</p>
                                                        <p className="text-gray-600 text-sm">{comment.comment}</p>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                        )) : (
                            <p className="col-span-full text-center text-gray-600 text-lg">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç</p>
                        )}
                    </div>
                </div>
            </div>
        );
    };

    // OTOP Products Page
    const OtopPage = () => {
        const [searchTerm, setSearchTerm] = useState('');
        const [selectedProvince, setSelectedProvince] = useState('');
        const [selectedCategory, setSelectedCategory] = useState('');
        const [otopProducts, setOtopProducts] = useState([]);
        const [loading, setLoading] = useState(true);
        const [error, setError] = useState('');

        const publicOtopRef = db ? collection(db, `artifacts/${appId}/public/data/otopProducts`) : null;

        useEffect(() => {
            if (!db || !isAuthReady || !publicOtopRef) {
                setLoading(false);
                return;
            };

            const unsubscribe = onSnapshot(publicOtopRef, (snapshot) => {
                const fetchedProducts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                setOtopProducts(fetchedProducts);
                setLoading(false);
            }, (err) => {
                setError('Failed to fetch OTOP products: ' + err.message);
                setLoading(false);
            });

            // Add mock data if collection is empty
            getDocs(publicOtopRef).then(snapshot => {
                if (snapshot.empty) {
                    mockOtopProducts.forEach(async (prod) => {
                        try {
                            // Ensure document ID is set to prod.id for consistent data
                            await setDoc(doc(publicOtopRef, prod.id), prod);
                            console.log(`Added mock OTOP product: ${prod.name}`);
                        } catch (e) {
                            console.error("Error adding mock OTOP product: ", e);
                        }
                    });
                }
            }).catch(e => console.error("Error checking OTOP products collection:", e));

            return () => unsubscribe();
        }, [db, isAuthReady, userId, appId, publicOtopRef]); // Added publicOtopRef to dependency array

        const filteredOtopProducts = otopProducts.filter(product => {
            const matchesSearch = product.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                                  product.description.toLowerCase().includes(searchTerm.toLowerCase()) ||
                                  product.origin.toLowerCase().includes(searchTerm.toLowerCase());
            const matchesProvince = selectedProvince === '' || product.origin.includes(selectedProvince); // Assuming origin contains province
            const matchesCategory = selectedCategory === '' || product.category === selectedCategory;
            // Add more filter logic for price range, OTOP 5 stars, etc.
            return matchesSearch && matchesProvince && matchesCategory;
        });

        if (loading) return <div className="text-center p-8 font-['Prompt'] text-xl">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ OTOP...</div>;
        if (error) return <div className="text-center p-8 font-['Prompt'] text-xl text-red-600">{error}</div>;

        return (
            <div className="min-h-screen bg-gray-50 p-6 font-['Prompt']">
                <div className="container mx-auto">
                    <h2 className="text-4xl font-bold text-gray-800 mb-8 text-center">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ OTOP ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</h2>

                    {/* Search & Filter */}
                    <div className="bg-white p-6 rounded-2xl shadow-xl mb-8 flex flex-col md:flex-row gap-4 items-center">
                        <input
                            type="text"
                            placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ / ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó / ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î"
                            className="flex-grow p-3 border border-gray-300 rounded-lg text-lg focus:ring-orange-500 focus:border-orange-500"
                            value={searchTerm}
                            onChange={(e) => setSearchTerm(e.target.value)}
                        />
                        <select
                            className="p-3 border border-gray-300 rounded-lg text-lg focus:ring-orange-500 focus:border-orange-500 w-full md:w-auto"
                            value={selectedProvince}
                            onChange={(e) => setSelectedProvince(e.target.value)}
                        >
                            <option value="">‡∏ó‡∏∏‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</option>
                            {thaiProvinces.map((p, idx) => <option key={idx} value={p}>{p}</option>)}
                        </select>
                        <select
                            className="p-3 border border-gray-300 rounded-lg text-lg focus:ring-orange-500 focus:border-orange-500 w-full md:w-auto"
                            value={selectedCategory}
                            onChange={(e) => setSelectedCategory(e.target.value)}
                        >
                            <option value="">‡∏ó‡∏∏‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</option>
                            <option value="‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°">‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°</option>
                            <option value="‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏ö‡πâ‡∏≤‡∏ô">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏ö‡πâ‡∏≤‡∏ô</option>
                            <option value="‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ú‡πâ‡∏≤">‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ú‡πâ‡∏≤</option>
                            <option value="‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå‡∏™‡∏°‡∏∏‡∏ô‡πÑ‡∏û‡∏£ / ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏á‡∏≤‡∏°">‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå‡∏™‡∏°‡∏∏‡∏ô‡πÑ‡∏û‡∏£ / ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏á‡∏≤‡∏°</option>
                            <option value="‡∏Ç‡∏≠‡∏á‡∏ù‡∏≤‡∏Å / ‡∏á‡∏≤‡∏ô‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏£‡∏£‡∏°">‡∏Ç‡∏≠‡∏á‡∏ù‡∏≤‡∏Å / ‡∏á‡∏≤‡∏ô‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏£‡∏£‡∏°</option>
                            <option value="‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ä‡∏∏‡∏°‡∏ä‡∏ô‡∏ï‡∏≤‡∏°‡∏§‡∏î‡∏π‡∏Å‡∏≤‡∏•">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ä‡∏∏‡∏°‡∏ä‡∏ô‡∏ï‡∏≤‡∏°‡∏§‡∏î‡∏π‡∏Å‡∏≤‡∏•</option>
                        </select>
                        {/* More filters */}
                    </div>

                    {/* OTOP Products Grid */}
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                        {filteredOtopProducts.length > 0 ? filteredOtopProducts.map(product => (
                            <div key={product.id} className="bg-white rounded-2xl shadow-lg overflow-hidden border border-gray-200 transform transition duration-300 hover:scale-[1.02] hover:shadow-xl">
                                <img
                                    src={product.images[0]}
                                    alt={product.name}
                                    className="w-full h-48 object-cover"
                                    onError={(e) => { e.target.onerror = null; e.target.src="https://placehold.co/400x250/E0E0E0/000?text=No+Image"; }}
                                />
                                <div className="p-5">
                                    <h3 className="text-xl font-bold text-gray-800 mb-2">{product.name}</h3>
                                    <p className="text-gray-600 text-sm mb-1">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà: {product.category}</p>
                                    <p className="text-gray-600 text-sm mb-3 line-clamp-3">{product.description}</p>
                                    <p className="text-gray-700 text-sm mb-1">
                                        üí∏ ‡∏£‡∏≤‡∏Ñ‡∏≤: {product.price} {product.pricePerUnit ? `(${product.pricePerUnit})` : ''}
                                    </p>
                                    <p className="text-gray-700 text-sm mb-3">
                                        ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ú‡∏•‡∏¥‡∏ï: {product.producer}, {product.origin}
                                    </p>
                                    <div className="flex flex-wrap gap-2 mt-3">
                                        <button onClick={() => console.log(`‡πÄ‡∏û‡∏¥‡πà‡∏° ${product.name} ‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ (‡∏à‡∏≥‡∏•‡∏≠‡∏á)`)} className="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-full text-sm">
                                            ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏£‡∏∞‡∏Å‡∏£‡πâ‡∏≤
                                        </button>
                                        {product.canOrderOnline && (
                                            <button onClick={() => console.log(`‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå ${product.name} (‡∏à‡∏≥‡∏•‡∏≠‡∏á)`)} className="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-full text-sm">
                                                ‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå
                                            </button>
                                        )}
                                        <button onClick={() => console.log(`‡πÅ‡∏ä‡∏£‡πå ${product.name} (‡∏à‡∏≥‡∏•‡∏≠‡∏á)`)} className="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-full text-sm">
                                            ‡πÅ‡∏ä‡∏£‡πå
                                        </button>
                                    </div>
                                    <a href={product.purchaseChannels.physicalStore} target="_blank" rel="noopener noreferrer" className="block text-blue-600 hover:underline text-sm font-semibold mt-3">
                                        üìç ‡∏î‡∏π‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô
                                    </a>
                                </div>
                            </div>
                        )) : (
                            <p className="col-span-full text-center text-gray-600 text-lg">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ OTOP ‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç</p>
                        )}
                    </div>
                </div>
            </div>
        );
    };

    // Reviews Page
    const ReviewsPage = ({ appId }) => { // Receive appId as prop
        const [reviewText, setReviewText] = useState('');
        const [reviewImages, setReviewImages] = useState([]);
        const [reviewVideos, setReviewVideos] = useState([]);
        const [starRating, setStarRating] = useState(0);
        const [submitLoading, setSubmitLoading] = useState(false);
        const [submitError, setSubmitError] = useState('');
        const [reviews, setReviews] = useState([]);
        const [summaries, setSummaries] = useState({}); // To store AI summaries for each review
        const [summaryLoading, setSummaryLoading] = useState({}); // Loading state for summaries
        const imageInputRef = useRef(null);
        const videoInputRef = useRef(null);

        const publicReviewsRef = db ? collection(db, `artifacts/${appId}/public/data/reviews`) : null;
        const privateReviewsRef = db && userId !== 'anonymous' ? collection(db, `artifacts/${appId}/users/${userId}/myReviews`) : null;

        useEffect(() => {
            if (!db || !isAuthReady || !publicReviewsRef) return;

            const unsubscribe = onSnapshot(publicReviewsRef, (snapshot) => {
                const fetchedReviews = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Sort by latest by default
                setReviews(fetchedReviews.sort((a, b) => b.timestamp?.toDate() - a.timestamp?.toDate()));
            }, (err) => {
                console.error("Failed to fetch reviews:", err);
            });

            return () => unsubscribe();
        }, [db, isAuthReady, userId, appId, publicReviewsRef]); // Added publicReviewsRef to dependency array

        const checkReviewSafety = async (text) => {
            if (!text.trim()) return { is_safe: true, reason: 'No text to check.' };

            const prompt = `‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏¢‡∏≤‡∏ö‡∏Ñ‡∏≤‡∏¢ ‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á ‡πÇ‡∏Ü‡∏©‡∏ì‡∏≤‡πÅ‡∏ù‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô JSON ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏∞‡∏ö‡∏∏ 'is_safe': true/false ‡πÅ‡∏•‡∏∞ 'reason': '‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•' \n\n‡∏£‡∏µ‡∏ß‡∏¥‡∏ß: "${text}"`;
            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });

            const payload = {
                contents: chatHistory,
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "is_safe": { "type": "BOOLEAN" },
                            "reason": { "type": "STRING" }
                        },
                        "propertyOrdering": ["is_safe", "reason"]
                    }
                }
            };
            const apiKey = ""; // Canvas will provide this. Do not set your actual key here.
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const jsonString = result.candidates[0].content.parts[0].text;
                    return JSON.parse(jsonString);
                } else {
                    console.warn("AI moderation response unexpected:", result);
                    return { is_safe: true, reason: 'AI response inconclusive, proceeding with caution.' };
                }
            } catch (error) {
                console.error("Error calling Gemini API for moderation:", error);
                return { is_safe: true, reason: 'AI moderation failed, proceeding without check.' };
            }
        };

        const getReviewSummary = async (reviewId, text) => {
            if (summaries[reviewId]) return; // Already summarized
            setSummaryLoading(prev => ({ ...prev, [reviewId]: true }));

            const prompt = `‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡πÑ‡∏î‡πâ‡πÉ‡∏à‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡πÉ‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢:\n\n"${text}"`;
            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });

            const payload = {
                contents: chatHistory,
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "summary": { "type": "STRING" }
                        },
                        "propertyOrdering": ["summary"]
                    }
                }
            };
            const apiKey = ""; // Canvas will provide this. Do not set your actual key here.
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const jsonString = result.candidates[0].content.parts[0].text;
                    const parsedJson = JSON.parse(jsonString);
                    setSummaries(prev => ({ ...prev, [reviewId]: parsedJson.summary }));
                } else {
                    setSummaries(prev => ({ ...prev, [reviewId]: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡πÑ‡∏î‡πâ' }));
                    console.warn("AI summary response unexpected:", result);
                }
            } catch (error) {
                setSummaries(prev => ({ ...prev, [reviewId]: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡∏∏‡∏õ' }));
                console.error("Error calling Gemini API for summary:", error);
            } finally {
                setSummaryLoading(prev => ({ ...prev, [reviewId]: false }));
            }
        };


        const handleImageUpload = (e) => {
            const files = Array.from(e.target.files);
            const newImages = files.filter(file => ['image/jpeg', 'image/png', 'image/webp'].includes(file.type));
            if (newImages.length > 0) {
                // For a real app, you'd upload these to Firebase Storage and save URLs
                // For demo, just store file objects (they won't persist on refresh)
                setReviewImages(prev => [...prev, ...newImages]);
                // Replaced alert with console.log
                console.log(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ${newImages.length} ‡∏£‡∏π‡∏õ (‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î)`);
            } else {
                // Replaced alert with console.log
                console.log('‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (jpg, png, webp) ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô');
            }
        };

        const handleVideoUpload = (e) => {
            const files = Array.from(e.target.files);
            const newVideos = files.filter(file => ['video/mp4', 'video/mov'].includes(file.type) && file.size <= 50 * 1024 * 1024); // 50MB
            if (newVideos.length > 0 && reviewVideos.length + newVideos.length <= 3) {
                setReviewVideos(prev => [...prev, ...newVideos]);
                // Replaced alert with console.log
                console.log(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠ ${newVideos.length} ‡∏Ñ‡∏•‡∏¥‡∏õ (‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î)`);
            } else if (reviewVideos.length + newVideos.length > 3) {
                // Replaced alert with console.log
                console.log('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 3 ‡∏Ñ‡∏•‡∏¥‡∏õ‡∏ï‡πà‡∏≠‡∏£‡∏µ‡∏ß‡∏¥‡∏ß');
            } else {
                // Replaced alert with console.log
                console.log('‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÑ‡∏ü‡∏•‡πå‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠ (mp4, mov) ‡πÅ‡∏•‡∏∞‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 50MB ‡∏ï‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏õ');
            }
        };

        const handleSubmitReview = async () => {
            if (!user || userId === 'anonymous') {
                setSubmitError('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏£‡∏µ‡∏ß‡∏¥‡∏ß');
                return;
            }
            if (!reviewText.trim() && reviewImages.length === 0 && reviewVideos.length === 0) {
                setSubmitError('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏£‡∏µ‡∏ß‡∏¥‡∏ß ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û/‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠');
                return;
            }
            if (starRating === 0) {
                setSubmitError('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏µ‡∏ß‡∏¥‡∏ß');
                return;
            }

            setSubmitLoading(true);
            setSubmitError('');

            // ‚ú® AI-powered content moderation
            if (reviewText.trim()) {
                const moderationResult = await checkReviewSafety(reviewText);
                if (!moderationResult.is_safe) {
                    setSubmitError(`‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°: ${moderationResult.reason}`);
                    setSubmitLoading(false);
                    return;
                }
            }


            try {
                // If publicReviewsRef is null, it means Firebase wasn't initialized properly or db is null.
                // In a real app, you'd want to handle this more robustly (e.g., show an error message instead of crashing).
                if (!publicReviewsRef) {
                    setSubmitError('Firebase Firestore is not initialized. Cannot submit review.');
                    setSubmitLoading(false);
                    return;
                }

                const newReview = {
                    reviewerId: userId,
                    reviewerName: user.displayName || user.email || `‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ${userId.substring(0, 8)}...`,
                    reviewerProfilePic: 'https://placehold.co/50x50/B0B0B0/000?text=üë§', // Placeholder
                    text: reviewText,
                    images: reviewImages.map(f => URL.createObjectURL(f)), // For demo, use object URLs
                    videos: reviewVideos.map(f => URL.createObjectURL(f)), // For demo, use object URLs
                    rating: starRating,
                    detailedRating: { atmosphere: starRating, value: starRating, service: starRating, convenience: starRating }, // Simplified for demo
                    timestamp: Timestamp.now(), // Use Firebase Timestamp
                    likes: 0,
                    comments: 0,
                    shares: 0
                };

                // Add review to public collection
                const docRef = await addDoc(publicReviewsRef, newReview); // Store the document reference
                // Optionally, add a reference to private collection if user wants to manage their own reviews
                if (privateReviewsRef) {
                    await setDoc(doc(privateReviewsRef, docRef.id), { timestamp: newReview.timestamp }); // Use the same doc ID
                }

                // Replaced alert with console.log
                console.log('‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÅ‡∏•‡πâ‡∏ß!');
                // Clear form
                setReviewText('');
                setReviewImages([]);
                setReviewVideos([]);
                setStarRating(0);
            } catch (err) {
                setSubmitError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏£‡∏µ‡∏ß‡∏¥‡∏ß: ' + err.message);
                console.error("Error submitting review:", err);
            } finally {
                setSubmitLoading(false);
            }
        };

        return (
            <div className="min-h-screen bg-gray-50 p-6 font-['Prompt']">
                <div className="container mx-auto">
                    <h2 className="text-4xl font-bold text-gray-800 mb-8 text-center">‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h2>

                    {/* Review Submission Form */}
                    <section className="bg-white p-6 rounded-2xl shadow-xl mb-8 border border-purple-200">
                        <h3 className="text-2xl font-semibold text-purple-700 mb-4">‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h3>
                        <textarea
                            className="w-full p-3 border border-gray-300 rounded-lg text-lg focus:ring-purple-500 focus:border-purple-500 resize-y min-h-[100px]"
                            placeholder="‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."
                            value={reviewText}
                            onChange={(e) => setReviewText(e.target.value)}
                        ></textarea>
                        <div className="mt-4 flex flex-wrap items-center gap-4">
                            <div>
                                <label className="block text-gray-700 text-sm font-medium mb-2">‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô:</label>
                                <div className="flex space-x-1">
                                    {[1, 2, 3, 4, 5].map((star) => (
                                        <span
                                            key={star}
                                            className={`text-4xl cursor-pointer transition-colors duration-200 ${star <= starRating ? 'text-yellow-500' : 'text-gray-300'}`}
                                            onClick={() => setStarRating(star)}
                                        >
                                            ‚≠ê
                                        </span>
                                    ))}
                                </div>
                            </div>
                            <button
                                onClick={() => imageInputRef.current.click()}
                                className="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 text-sm"
                            >
                                ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ({reviewImages.length})
                            </button>
                            <input
                                type="file"
                                ref={imageInputRef}
                                onChange={handleImageUpload}
                                accept="image/jpeg,image/png,image/webp"
                                multiple
                                className="hidden"
                            />
                            <button
                                onClick={() => videoInputRef.current.click()}
                                className="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 text-sm"
                            >
                                ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠ ({reviewVideos.length})
                            </button>
                            <input
                                type="file"
                                ref={videoInputRef}
                                onChange={handleVideoUpload}
                                accept="video/mp4,video/mov"
                                multiple
                                className="hidden"
                            />
                        </div>
                        {reviewImages.length > 0 && (
                            <div className="mt-2 flex flex-wrap gap-2">
                                {reviewImages.map((file, idx) => (
                                    <img key={idx} src={URL.createObjectURL(file)} alt={`‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ${idx + 1}`} className="w-24 h-24 object-cover rounded-md" />
                                ))}
                            </div>
                        )}
                        {reviewVideos.length > 0 && (
                            <div className="mt-2 flex flex-wrap gap-2">
                                {reviewVideos.map((file, idx) => (
                                    <video key={idx} src={URL.createObjectURL(file)} controls className="w-24 h-24 object-cover rounded-md" />
                                ))}
                            </div>
                        )}
                        {submitError && <p className="text-red-500 text-center mt-4">{submitError}</p>}
                        <button
                            onClick={handleSubmitReview}
                            className="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 rounded-xl shadow-lg mt-6 transition duration-300 text-lg"
                            disabled={submitLoading || (!reviewText.trim() && reviewImages.length === 0 && reviewVideos.length === 0) || starRating === 0}
                        >
                            {submitLoading ? (
                                <span className="flex items-center justify-center">
                                    <svg className="animate-spin h-5 w-5 mr-3 text-white" viewBox="0 0 24 24">
                                        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                    ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏û‡∏™‡∏ï‡πå...
                                </span>
                            ) : (
                                '‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏£‡∏µ‡∏ß‡∏¥‡∏ß'
                            )}
                        </button>
                    </section>

                    {/* Review Display */}
                    <section>
                        <h3 className="text-2xl font-semibold text-gray-800 mb-4">‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            {reviews.length > 0 ? reviews.map(review => (
                                <div key={review.id} className="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                                    <div className="flex items-center mb-4">
                                        <img src={review.reviewerProfilePic} alt={review.reviewerName} className="w-12 h-12 rounded-full mr-4" />
                                        <div>
                                            <p className="font-bold text-lg text-gray-800">{review.reviewerName}</p>
                                            <p className="text-gray-500 text-sm">{new Date(review.timestamp?.toDate()).toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
                                        </div>
                                    </div>
                                    <div className="flex items-center text-yellow-500 mb-3 text-xl">
                                        {'‚≠ê'.repeat(Math.round(review.rating))} ({review.rating})
                                    </div>
                                    <p className="text-gray-700 text-base mb-4">{review.text}</p>
                                    {review.images && review.images.length > 0 && (
                                        <div className="flex flex-wrap gap-2 mb-4">
                                            {review.images.map((imgSrc, idx) => (
                                                <img key={idx} src={imgSrc} alt={`‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö ${idx + 1}`} className="w-32 h-32 object-cover rounded-md" />
                                            ))}
                                        </div>
                                    )}
                                    {review.videos && review.videos.length > 0 && (
                                        <div className="flex flex-wrap gap-2 mb-4">
                                            {review.videos.map((videoSrc, idx) => (
                                                <video key={idx} src={videoSrc} controls className="w-32 h-32 object-cover rounded-md" />
                                            ))}
                                        </div>
                                    )}
                                    {/* ‚ú® AI-powered review summarization */}
                                    {review.text && (
                                        <div className="mt-4">
                                            <button
                                                onClick={() => getReviewSummary(review.id, review.text)}
                                                className="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-full text-sm flex items-center justify-center transition duration-300"
                                                disabled={summaryLoading[review.id]}
                                            >
                                                {summaryLoading[review.id] ? (
                                                    <svg className="animate-spin h-4 w-4 mr-2" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                                ) : (
                                                    '‚ú® ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏î‡πâ‡∏ß‡∏¢ AI'
                                                )}
                                            </button>
                                            {summaries[review.id] && (
                                                <p className="mt-2 text-gray-700 text-sm bg-gray-100 p-2 rounded-md border border-gray-200">
                                                    <strong>‡∏™‡∏£‡∏∏‡∏õ:</strong> {summaries[review.id]}
                                                </p>
                                            )}
                                        </div>
                                    )}
                                    <div className="flex justify-around border-t pt-4 text-gray-600 mt-4">
                                        <button className="flex items-center hover:text-blue-600">üëç {review.likes} ‡∏ñ‡∏π‡∏Å‡πÉ‡∏à</button>
                                        <button className="flex items-center hover:text-blue-600">üí¨ {review.comments} ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡πá‡∏ô</button>
                                        <button className="flex items-center hover:text-blue-600">üì§ {review.shares} ‡πÅ‡∏ä‡∏£‡πå</button>
                                    </div>
                                </div>
                            )) : (
                                <p className="col-span-full text-center text-gray-600 text-lg">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß</p>
                            )}
                        </div>
                    </section>
                </div>
            </div>
        );
    };


    // Main App rendering logic
    return (
        // NOTE: Added pb-24 to prevent content from being hidden by the bottom navbar
        <div className="App pb-24" style={{ fontFamily: "'Prompt', sans-serif" }}>
            <style>
                {`
                @import url('https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap');
                /* Fallback for Fc Inconnic if not available */
                /* For production, consider self-hosting Fc Inconnic or using a reliable CDN */
                `}
            </style>

            {/* Conditional page rendering */}
            {!isAuthReady ? (
                <div className="min-h-screen flex items-center justify-center bg-gray-100 text-gray-700 text-2xl font-['Prompt']">
                    ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô...
                </div>
            ) : (
                <>
                    {currentPage === 'home' && <HomePage />}
                    {currentPage === 'login' && <LoginPage />}
                    {currentPage === 'dashboard' && user && <DashboardPage />}
                    {currentPage === 'attractions' && user && (
                        <AttractionsPage
                            db={db}
                            auth={auth}
                            user={user}
                            userId={userId}
                            isAuthReady={isAuthReady}
                            appId={appId}
                        />
                    )}
                    {currentPage === 'restaurants' && user && <RestaurantsPage />}
                    {currentPage === 'otop' && user && <OtopPage />}
                    {currentPage === 'reviews' && user && <ReviewsPage appId={appId} />} {/* Pass appId to ReviewsPage */}

                    {/* Redirect to home/login if user is not authenticated and trying to access a protected page */}
                    {isAuthReady && !user && (currentPage === 'dashboard' || currentPage === 'attractions' || currentPage === 'restaurants' || currentPage === 'otop' || currentPage === 'reviews') && (
                        <div className="min-h-screen flex flex-col items-center justify-center bg-gray-100 text-gray-700 text-2xl font-['Prompt'] p-4 text-center">
                            <p className="mb-4">‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô</p>
                            <button
                                onClick={() => setCurrentPage('login')}
                                className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transition duration-300 hover:scale-105 text-xl"
                            >
                                ‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
                            </button>
                        </div>
                    )}
                </>
            )}

            {/* Render Navbar if user is logged in */}
            {user && <Navbar />}
        </div>
    );
};

export default App;
